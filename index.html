<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#5A9E8F">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Vías Verdes de Murcia | Mapa Interactivo con Tours 360°</title>

    <!-- MapLibre GL JS (GRATIS - No requiere token) -->
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="data.js"></script>
    <script src="pois.js"></script>
    <script src="weather.js"></script>
    <script src="transport.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- iOS 26 Liquid Glass Design System -->
    <link rel="stylesheet" href="styles.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        murcia: {
                            DEFAULT: '#5A9E8F',
                            light: '#7DBCAD',
                            dark: '#1E3330',
                            accent: '#7DBCAD',
                            glow: '#9ED1C4'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* ==================== iOS 26 LIQUID GLASS — CSS CUSTOM PROPERTIES ==================== */
        :root {
            --bg-primary: #F4F3EE;
            --bg-secondary: rgba(230, 240, 237, 0.45);
            --bg-sidebar: rgba(244, 243, 238, 0.82);
            --bg-header: linear-gradient(135deg, rgba(90, 158, 143, 0.92), rgba(30, 51, 48, 0.95));
            --text-primary: #2C3E3A;
            --text-secondary: #607A74;
            --text-muted: #8EA09B;
            --border-color: rgba(201, 212, 196, 0.45);
            --card-bg: rgba(255, 255, 255, 0.55);
            --card-border: rgba(201, 212, 196, 0.5);
            --card-shadow: rgba(0, 0, 0, 0.06);
            --card-hover-shadow: rgba(90, 158, 143, 0.18);
            --input-bg: rgba(255, 255, 255, 0.6);
            --input-text: #2C3E3A;
            --modal-bg: rgba(244, 243, 238, 0.88);
            --modal-overlay: rgba(30, 51, 48, 0.25);
            --stat-bg: rgba(230, 240, 237, 0.5);
            --stat-border: rgba(201, 212, 196, 0.6);
            --chart-bg: rgba(230, 240, 237, 0.45);
            --chart-border: rgba(201, 212, 196, 0.5);
            --chart-grid: rgba(44, 62, 58, 0.06);
            --legend-bg: rgba(230, 240, 237, 0.5);
            --filter-bg: rgba(230, 240, 237, 0.5);
            --filter-hover-bg: rgba(90, 158, 143, 0.08);
            --scrollbar-track: transparent;
            --scrollbar-thumb: rgba(90, 158, 143, 0.25);
            --scrollbar-hover: rgba(90, 158, 143, 0.4);
            --badge-easy-bg: rgba(90, 158, 143, 0.15);
            --badge-easy-text: #2C3E3A;
            --badge-medium-bg: rgba(245, 158, 11, 0.15);
            --badge-medium-text: #92400e;
            --badge-hard-bg: rgba(239, 68, 68, 0.15);
            --badge-hard-text: #991b1b;
            --attribution-bg: rgba(244, 243, 238, 0.6);
            --attribution-text: #8EA09B;
            --btn-secondary-bg: rgba(230, 240, 237, 0.5);
            --btn-secondary-text: #2C3E3A;
            --btn-secondary-hover: rgba(230, 240, 237, 0.7);
            --loader-from: #5A9E8F;
            --loader-to: #1E3330;
            --glass-blur: blur(40px) saturate(180%);
            --glass-blur-light: blur(20px) saturate(150%);
            --glass-border: 1px solid rgba(201, 212, 196, 0.45);
            --glass-inset: inset 0 1px 0 rgba(255, 255, 255, 0.5), inset 0 -1px 0 rgba(0, 0, 0, 0.05);
            --glass-shadow: 0 8px 32px rgba(30, 51, 48, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* ==================== BASE STYLES ==================== */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body, input, button, select, textarea {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ==================== LANGUAGE SELECTOR — Flag Icons ==================== */
        .lang-switch {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .lang-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            background: transparent;
            padding: 0;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.45;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .lang-btn svg {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: block;
        }
        .lang-btn.active {
            opacity: 1;
            border-color: rgba(255,255,255,0.7);
            box-shadow: 0 0 8px rgba(255,255,255,0.25);
        }
        .lang-btn:hover:not(.active) {
            opacity: 0.75;
            border-color: rgba(255,255,255,0.3);
        }

        /* ==================== INFO SIDE PANEL — Right Edge ==================== */
        .info-side-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 380px;
            max-width: 100vw;
            z-index: 70;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            background: var(--modal-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-left: 1px solid rgba(255,255,255,0.3);
            box-shadow: -8px 0 40px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .info-side-panel.open {
            transform: translateX(0);
        }
        .info-side-overlay {
            position: fixed;
            inset: 0;
            z-index: 69;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .info-side-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        @media (max-width: 480px) {
            .info-side-panel {
                width: 100vw;
            }
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Custom Scrollbar — Glass */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-hover);
        }

        /* Route Cards — Liquid Glass */
        .route-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.3) 100%);
            backdrop-filter: var(--glass-blur-light);
            -webkit-backdrop-filter: var(--glass-blur-light);
            border-radius: 18px;
            padding: 16px;
            box-shadow: var(--glass-shadow), var(--glass-inset);
            border: var(--glass-border);
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .route-card:hover {
            box-shadow: 0 12px 40px var(--card-hover-shadow), var(--glass-inset);
            border-color: rgba(90, 158, 143, 0.3);
            transform: translateY(-3px) scale(1.01);
        }

        .route-card:active {
            transform: scale(0.98);
            transition-duration: 0.1s;
        }

        /* POI Icons */
        .poi-mirador { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .poi-tunel { background: linear-gradient(135deg, #6B7280, #4B5563); }
        .poi-estacion { background: linear-gradient(135deg, #5A9E8F, #1E3330); }
        .poi-patrimonio { background: linear-gradient(135deg, #92400E, #78350F); }
        .poi-servicio { background: linear-gradient(135deg, #0EA5E9, #0284C7); }
        .poi-playa { background: linear-gradient(135deg, #06B6D4, #0891B2); }
        .poi-puente { background: linear-gradient(135deg, #D97706, #B45309); }
        .poi-panel_interpretativo { background: linear-gradient(135deg, #3B82F6, #2563EB); }
        .poi-punto_conflictivo { background: linear-gradient(135deg, #DC2626, #B91C1C); }
        .poi-albergue { background: linear-gradient(135deg, #059669, #047857); }
        .poi-area_descanso { background: linear-gradient(135deg, #84CC16, #65A30D); }
        .poi-pueblo { background: linear-gradient(135deg, #7C3AED, #6D28D9); }
        .poi-restaurante { background: linear-gradient(135deg, #E11D48, #BE123C); }
        .poi-aparcamiento { background: linear-gradient(135deg, #2563EB, #1D4ED8); }
        .poi-fuente_agua { background: linear-gradient(135deg, #0891B2, #0E7490); }
        .poi-camping { background: linear-gradient(135deg, #15803D, #166534); }
        .poi-centro_salud { background: linear-gradient(135deg, #E11D48, #BE123C); }

        /* Info Modal — Liquid Glass */
        /* Info modal styles moved to .info-side-panel in base styles */
        .info-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .info-accordion-content:not(.hidden) {
            max-height: 300px;
        }
        .info-chevron-open {
            transform: rotate(180deg) !important;
        }

        /* Badges — Glass Pills */
        .badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 100px;
            font-weight: 600;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid transparent;
            letter-spacing: 0.01em;
        }

        .badge-easy {
            background: rgba(90, 158, 143, 0.85);
            color: #ffffff;
            border-color: rgba(90, 158, 143, 0.4);
        }

        .badge-medium {
            background: #f59e0b;
            color: #ffffff;
            border-color: rgba(245, 158, 11, 0.4);
        }

        .badge-hard {
            background: #ef4444;
            color: #ffffff;
            border-color: rgba(239, 68, 68, 0.4);
        }

        .badge-tour360 {
            background: linear-gradient(135deg, rgba(90, 158, 143, 0.85), rgba(125, 188, 173, 0.85));
            color: white;
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(90, 158, 143, 0.3), inset 0 1px 0 rgba(255,255,255,0.15);
        }

        /* Tour 360° featured banner in route cards — clean & compact */
        .tour360-card-banner {
            margin-top: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #5A9E8F, #7DBCAD);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(90, 158, 143, 0.2);
        }
        .tour360-card-banner:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(90, 158, 143, 0.35), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .tour360-card-banner:active {
            transform: scale(0.98);
        }

        .badge-soon {
            background: rgba(255, 255, 255, 0.5);
            color: #8e90a6;
            border: 1px dashed rgba(0, 0, 0, 0.15);
        }

        /* MapLibre Popup — Glass */
        .maplibregl-popup-content {
            padding: 0 !important;
            border-radius: 18px !important;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15), var(--glass-inset) !important;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.82) !important;
            backdrop-filter: var(--glass-blur) !important;
            -webkit-backdrop-filter: var(--glass-blur) !important;
            border: var(--glass-border) !important;
            color: var(--text-primary) !important;
        }

        .maplibregl-popup-close-button {
            font-size: 20px;
            color: white;
            right: 8px;
            top: 8px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            width: 28px;
            height: 28px;
        }

        /* POI Marker — Glass Circular */
        .poi-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px) saturate(150%);
            -webkit-backdrop-filter: blur(12px) saturate(150%);
            border: 2px solid var(--poi-color, #6B7280);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.6);
            cursor: pointer;
            /* NO transform on container — keeps marker anchored to map */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: box-shadow 0.25s;
        }
        .poi-marker svg {
            width: 14px;
            height: 14px;
            color: var(--poi-color, #6B7280);
            stroke: var(--poi-color, #6B7280);
            flex-shrink: 0;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .poi-marker:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.6);
            z-index: 20 !important;
        }
        .poi-marker:hover svg {
            transform: scale(1.3);
        }
        @media (max-width: 768px) {
            .poi-marker {
                width: 34px;
                height: 34px;
            }
            .poi-marker svg {
                width: 16px;
                height: 16px;
            }
        }
        .poi-marker .poi-tip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            color: var(--text-primary);
            padding: 8px 14px;
            border-radius: 14px;
            font-size: 11px;
            line-height: 1.4;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.5);
            border: 1px solid rgba(255, 255, 255, 0.5);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            max-width: 250px;
            white-space: normal;
            text-align: left;
        }
        .poi-marker .poi-tip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.88);
        }
        .poi-marker:hover .poi-tip { opacity: 1; }

        .poi-group-items { display: none; }
        .poi-group-items:not(.hidden) { display: flex; }
        .poi-chevron-open { transform: rotate(180deg) !important; }

        /* Modal — Liquid Glass */
        .modal-container {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(16px) saturate(120%);
            -webkit-backdrop-filter: blur(16px) saturate(120%);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-content {
            background: var(--modal-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 28px;
            width: 100%;
            max-width: 480px;
            max-height: 92vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.25), var(--glass-inset);
            border: var(--glass-border);
            animation: modalPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop {
            from {
                transform: scale(0.85) translateY(40px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            position: relative;
            height: 240px;
        }

        .modal-header-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-header-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 40%, rgba(0, 0, 0, 0.5) 100%);
        }

        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: rotate(90deg) scale(1.05);
        }

        .modal-body {
            padding: 28px;
            overflow-y: auto;
            flex: 1;
            color: var(--text-primary);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 16px 8px;
            border-radius: 18px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
        }

        .stat-card .val {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-card .label {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 6px;
        }

        .chart-container {
            margin-bottom: 24px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.45);
            position: relative;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
        }

        .chart-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .chart-stat-item {
            text-align: center;
        }

        .chart-stat-val {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-stat-lbl {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Filter Checkbox — Glass */
        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }

        .filter-item:hover {
            border-color: rgba(90, 158, 143, 0.3);
            background: rgba(90, 158, 143, 0.06);
        }

        .filter-item input {
            display: none;
        }

        .filter-item input:checked+span+span {
            font-weight: 600;
            color: #5A9E8F;
        }

        /* Responsive Sidebar — Glass Mobile */
        @media (max-width: 1024px) {
            #sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 28vh;
                max-height: 28vh;
                border-radius: 24px 24px 0 0;
                z-index: 40;
                transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1), max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 -8px 40px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.5);
            }

            #sidebar.sidebar-expanded {
                height: 60vh;
                max-height: 60vh;
            }

            #sidebar header {
                padding: 10px 14px;
            }

            #sidebar header img {
                width: 120px !important;
            }

            #sidebar header h1 {
                font-size: 13px !important;
            }

            #sidebar header p {
                font-size: 10px !important;
            }

            /* Sidebar drag handle — Glass */
            .sidebar-handle {
                display: flex;
                justify-content: center;
                padding: 10px 0 4px;
                cursor: grab;
            }

            .sidebar-handle-bar {
                width: 40px;
                height: 5px;
                border-radius: 3px;
                background: rgba(0, 0, 0, 0.12);
            }

            .sidebar-toggle-btn {
                display: flex;
            }

            /* Compress content */
            #sidebar .route-card {
                padding: 10px;
            }

            #sidebar .flex.text-sm {
                font-size: 12px;
            }

            #sidebar .p-4 {
                padding: 8px 12px;
            }

            #sidebar .space-y-3 > * + * {
                margin-top: 8px;
            }

            /* Footer buttons smaller */
            #sidebar .p-3.flex.gap-2 {
                padding: 6px 8px;
            }

            /* Legend compact */
            #legend {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                border-radius: 24px;
                max-height: 95vh;
            }
            .modal-tab {
                font-size: 11px;
                padding: 10px 4px;
            }
            .modal-header {
                height: 200px;
            }
            .modal-body {
                padding: 20px;
            }
            .municipality-badges {
                gap: 4px;
            }
            .municipality-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
            .share-btn {
                font-size: 11px;
                padding: 8px 10px;
                min-width: 70px;
            }
        }

        @media (min-width: 1025px) {
            .sidebar-handle { display: none; }
            .sidebar-toggle-btn { display: none; }
        }

        /* Share Buttons — Glass */
        .share-options-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            justify-content: center;
            min-width: 100px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .share-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .share-btn:active {
            transform: scale(0.97);
        }

        .share-btn-whatsapp {
            background: rgba(37, 211, 102, 0.85);
            color: white;
        }

        .share-btn-telegram {
            background: rgba(0, 136, 204, 0.85);
            color: white;
        }

        .share-btn-copy {
            background: rgba(255, 255, 255, 0.5);
            color: var(--btn-secondary-text);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .share-btn-twitter {
            background: rgba(0, 0, 0, 0.8);
            color: white;
        }

        .share-btn-email {
            background: rgba(99, 102, 241, 0.85);
            color: white;
        }

        /* Tab System — Glass Pills */
        .modal-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.04);
            border-radius: 16px;
        }

        .modal-tab {
            flex: 1;
            padding: 10px 8px;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        .modal-tab:hover {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.5);
        }

        .modal-tab.active {
            color: #5A9E8F;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255,255,255,0.6);
        }

        .modal-tab-content {
            display: none;
            animation: tabFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-tab-content.active {
            display: block;
        }

        @keyframes tabFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Municipality Badges — Glass Pills */
        .municipality-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .municipality-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 100px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.5);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Itinerario Step — Glass */
        .itinerario-step {
            display: flex;
            gap: 14px;
            padding: 14px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .itinerario-step:last-child {
            border-bottom: none;
        }

        .itinerario-km {
            flex-shrink: 0;
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), inset 0 -1px 2px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 800;
            color: #5A9E8F;
            line-height: 1;
        }

        .itinerario-km small {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .itinerario-info h4 {
            margin: 0 0 4px;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .itinerario-info p {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .itinerario-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 100px;
            font-weight: 600;
            margin-top: 6px;
        }

        /* Patrimonio Card — Glass */
        .patrimonio-card {
            display: flex;
            gap: 12px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
            transition: all 0.25s;
        }

        .patrimonio-card:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .patrimonio-icon {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .patrimonio-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .patrimonio-info h4 {
            margin: 0 0 4px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .patrimonio-info p {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Servicio Card — Glass */
        .servicio-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background 0.2s;
        }

        .servicio-card:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .servicio-card:last-child {
            border-bottom: none;
        }

        .servicio-icon {
            width: 36px;
            height: 36px;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .servicio-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .servicio-info {
            flex: 1;
        }

        .servicio-info h4 {
            margin: 0 0 2px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .servicio-info p {
            margin: 0;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* GPX Download Button — Glass */
        .gpx-download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 2px dashed rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.25s;
        }

        .gpx-download-btn:hover {
            border-color: rgba(90, 158, 143, 0.4);
            color: #5A9E8F;
            background: rgba(90, 158, 143, 0.06);
        }

        .gpx-download-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Surface/Type Badges — Glass */
        .badge-surface {
            background: rgba(255, 255, 255, 0.5);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .badge-type {
            background: rgba(90, 158, 143, 0.1);
            color: #5A9E8F;
            border: 1px solid rgba(90, 158, 143, 0.15);
        }

        /* Status indicator — Glass */
        .badge-operational {
            background: #22c55e;
            color: #ffffff;
            border: 1px solid rgba(16, 185, 129, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-coming-soon {
            background: rgba(255, 255, 255, 0.5);
            color: #8e90a6;
            border: 1px dashed rgba(0, 0, 0, 0.12);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Empty state */
        .tab-empty {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .tab-empty svg {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            opacity: 0.4;
        }

        /* Banner instalacion PWA — Glass */
        #installBanner {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: var(--glass-blur-light);
            -webkit-backdrop-filter: var(--glass-blur-light);
            border: var(--glass-border);
            color: var(--text-primary);
            box-shadow: var(--glass-shadow);
        }

        /* KM Markers — Glass (anchored properly to map) */
        .km-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            /* NO transform here — let MapLibre handle positioning */
        }
        .km-marker:hover { z-index: 15; }
        .km-marker:hover > div { transform: scale(1.2); }

        .km-marker-dot {
            min-width: 22px;
            height: 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1.5px solid rgba(90, 158, 143, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7.5px;
            font-weight: 600;
            color: #607A74;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.4);
            padding: 0 4px;
            white-space: nowrap;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Intermediate km markers — full size, same as dot */
        .km-marker-mini .km-marker-dot {
            /* Full size, no scale reduction */
        }
        .km-marker-mini:hover .km-marker-dot {
            transform: scale(1.15);
        }

        .km-marker-start {
            min-width: 28px;
            height: 18px;
            border-radius: 9px;
            background: rgba(90, 158, 143, 0.85);
            backdrop-filter: blur(8px);
            border: 1.5px solid rgba(255,255,255,0.5);
            color: white;
            font-size: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(90, 158, 143, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            padding: 0 5px;
            white-space: nowrap;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .km-marker:hover .km-marker-start { transform: scale(1.15); }

        .km-marker-end {
            min-width: 28px;
            height: 18px;
            border-radius: 9px;
            background: rgba(30, 51, 48, 0.8);
            backdrop-filter: blur(8px);
            border: 1.5px solid rgba(255,255,255,0.5);
            color: white;
            font-size: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(30, 51, 48, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            padding: 0 5px;
            white-space: nowrap;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .km-marker:hover .km-marker-end { transform: scale(1.15); }

        /* ==================== FLOATING MAP BUTTONS — Apple Style ==================== */
        .map-float-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1), 0 1px 4px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .map-float-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 24px rgba(0,0,0,0.14), 0 2px 8px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.6);
        }
        .map-float-btn:active {
            transform: scale(0.95);
        }
        .map-float-btn.active {
            background: rgba(90, 158, 143, 0.12);
            border-color: rgba(90, 158, 143, 0.3);
            box-shadow: 0 4px 16px rgba(90, 158, 143, 0.15), inset 0 1px 0 rgba(255,255,255,0.3);
        }
        .map-float-btn-wrapper {
            position: relative;
        }
        .weather-popup {
            position: absolute;
            right: calc(100% + 10px);
            bottom: 0;
            width: 280px;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.06);
            padding: 4px;
            animation: scaleIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: bottom right;
        }
        .weather-popup.hidden { display: none; }

        /* ==================== WEATHER MODULE — Glass ==================== */
        #weatherWidget {
            margin: 0;
        }
        .weather-widget-inner {
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(16px) saturate(150%);
            -webkit-backdrop-filter: blur(16px) saturate(150%);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
        }
        .weather-badge {
            font-size: 11px !important;
            padding: 3px 8px !important;
            border-radius: 100px !important;
        }
        .forecast-day-card {
            text-align: center;
            padding: 10px 6px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .weather-modal-section {
            margin-bottom: 20px;
        }
        @media (max-width: 480px) {
            .weather-widget-inner { padding: 10px 12px; }
            .weather-widget-inner > div:first-child span:first-child { font-size: 24px !important; }
            .forecast-day-card { padding: 8px 4px; }
        }

        /* ==================== TRANSPORT — Glass ==================== */
        .transport-radius-bar {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.04);
            border-radius: 14px;
        }
        .transport-radius-btn {
            flex: 1;
            padding: 6px 10px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }
        .transport-radius-btn:hover { color: #5A9E8F; background: rgba(255,255,255,0.4); }
        .active-radius {
            background: rgba(90, 158, 143, 0.88) !important;
            backdrop-filter: blur(8px);
            color: white !important;
            box-shadow: 0 2px 8px rgba(90, 158, 143, 0.3), inset 0 1px 0 rgba(255,255,255,0.15);
        }
        .transport-route-group {
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
        }
        .transport-route-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: background 0.2s;
        }
        .transport-route-header:hover { background: rgba(255, 255, 255, 0.3); }
        .transport-chevron {
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 10px;
            color: var(--text-muted);
        }
        .transport-chevron-open { transform: rotate(180deg); }
        .transport-route-body {
            display: none;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }
        .transport-route-body.open { display: block; }
        .transport-stop-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 12px;
        }
        .transport-stop-card:hover { background: rgba(255, 255, 255, 0.3); }
        .transport-stop-card + .transport-stop-card {
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }
        .transport-stop-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            flex-shrink: 0;
        }
        .transport-stop-name {
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.3;
        }
        .transport-stop-type {
            font-size: 10px;
            color: var(--text-muted);
        }
        .transport-stop-dist {
            font-weight: 700;
            font-size: 11px;
            white-space: nowrap;
        }
        .transport-endpoint-section {
            margin-bottom: 16px;
        }
        .transport-endpoint-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .transport-modal-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 14px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.4);
        }
        .transport-modal-card:hover { background: rgba(255, 255, 255, 0.6); }
        .transit-directions-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: rgba(26, 115, 232, 0.88);
            backdrop-filter: blur(8px);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.25s;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
        }
        .transit-directions-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .transport-loading {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
            font-size: 13px;
        }
        .transport-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 12px;
        }
        .transport-map-btn {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(150%);
            -webkit-backdrop-filter: blur(16px) saturate(150%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.5);
            transition: all 0.25s;
        }
        .transport-map-btn.active {
            background: rgba(90, 158, 143, 0.88);
            border-color: rgba(90, 158, 143, 0.5);
            box-shadow: 0 2px 12px rgba(90, 158, 143, 0.3);
        }
        /* Transport Markers — Glass */
        .transport-marker {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.88);
            backdrop-filter: blur(16px) saturate(150%);
            -webkit-backdrop-filter: blur(16px) saturate(150%);
            border-radius: 100px;
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 2px 12px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.5);
            font-size: 11px;
            font-weight: 500;
            color: #1a1a2e;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s;
            white-space: nowrap;
        }
        .transport-marker:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .transport-marker-icon {
            font-size: 14px;
        }
    </style>
</head>

<body class="font-sans" style="background:var(--bg-primary);">

    <!-- Loading Screen -->
    <div id="loader"
        class="fixed inset-0 z-[9999] bg-gradient-to-br from-murcia to-murcia-dark flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-white text-center">
            <img src="assets/images/logo principal vias verdes_1.webp"
                class="w-64 mx-auto mb-6 object-contain animate-pulse"
                style="border-radius: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);"
                alt="Vías Verdes Logo">
            <h1 class="text-3xl font-bold tracking-tight">Vías Verdes</h1>
            <p class="text-xl opacity-90">Región de Murcia</p>
        </div>
        <p id="loaderMsg" class="text-sm text-white/70 mt-6 font-light">Cargando mapa interactivo...</p>
    </div>

    <!-- Main Container -->
    <div class="flex h-screen">

        <!-- Sidebar — Liquid Glass -->
        <aside id="sidebar" class="w-[380px] z-20 flex flex-col overflow-hidden" style="background:var(--bg-sidebar); backdrop-filter:blur(40px) saturate(180%); -webkit-backdrop-filter:blur(40px) saturate(180%); box-shadow:8px 0 40px rgba(0,0,0,0.08), inset -1px 0 0 rgba(255,255,255,0.3); border-right:1px solid rgba(255,255,255,0.3);">

            <!-- CHANGE 3: Drag handle for mobile -->
            <div class="sidebar-handle" onclick="toggleSidebarMobile()">
                <div class="sidebar-handle-bar"></div>
            </div>

            <!-- Header — Liquid Glass -->
            <header class="text-white" style="background:linear-gradient(135deg, rgba(90,158,143,0.92), rgba(30,51,48,0.95)); backdrop-filter:blur(20px) saturate(150%); -webkit-backdrop-filter:blur(20px) saturate(150%); box-shadow:inset 0 -1px 0 rgba(255,255,255,0.1), 0 4px 20px rgba(90,158,143,0.2); padding:16px 20px 14px;">
                <div style="display:flex; flex-direction:column; align-items:center; text-align:center; margin-bottom:12px;">
                    <img src="assets/images/logo principal vias verdes_1.webp"
                        style="width:100%; max-width:320px; height:auto; object-fit:contain; border-radius:16px; margin-bottom:8px;"
                        alt="Vías Verdes">
                    <h1 id="headerTitle" style="font-size:15px; font-weight:700; margin:0; line-height:1.2; letter-spacing:-0.2px;">Vías Verdes Región de Murcia</h1>
                    <div style="display:flex; align-items:center; gap:8px; margin-top:4px;">
                        <p id="headerSubtitle" style="font-size:11px; opacity:0.8; margin:0; font-weight:400;">8 rutas · 180+ km · Tours 360°</p>
                        <div class="lang-switch">
                            <button class="lang-btn active" data-lang="es" onclick="setLanguage('es')" title="Español">
                                <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><clipPath id="esClip"><circle cx="18" cy="18" r="18"/></clipPath><g clip-path="url(#esClip)"><rect width="36" height="36" fill="#C60B1E"/><rect y="9" width="36" height="18" fill="#FFC400"/></g></svg>
                            </button>
                            <button class="lang-btn" data-lang="en" onclick="setLanguage('en')" title="English">
                                <svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><clipPath id="enClip"><circle cx="18" cy="18" r="18"/></clipPath><g clip-path="url(#enClip)"><rect width="36" height="36" fill="#012169"/><path d="M0 0L36 36M36 0L0 36" stroke="#fff" stroke-width="6"/><path d="M0 0L36 36M36 0L0 36" stroke="#C8102E" stroke-width="2"/><path d="M18 0V36M0 18H36" stroke="#fff" stroke-width="10"/><path d="M18 0V36M0 18H36" stroke="#C8102E" stroke-width="6"/></g></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Search -->
                <div class="relative">
                    <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-murcia-dark/50" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="searchInput" placeholder="Buscar ruta o punto..."
                        class="w-full pl-9 pr-4 py-2.5 text-murcia-dark text-sm placeholder:text-murcia-dark/50 focus:outline-none focus:ring-2 focus:ring-white/40" style="background:rgba(255,255,255,0.7); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border-radius:14px; border:1px solid rgba(255,255,255,0.4); box-shadow:inset 0 1px 2px rgba(0,0,0,0.06), inset 0 -1px 0 rgba(255,255,255,0.3);">
                </div>
            </header>

            <!-- Tabs — iOS 26 Glass Pill Bar -->
            <div class="tab-bar-glass">
                <button id="tabRoutes"
                    class="tab-item-glass active"
                    onclick="switchTab('routes')">
                    Rutas
                </button>
                <button id="tabPOIs" class="tab-item-glass"
                    onclick="switchTab('pois')">
                    POIs
                </button>
                <button id="tabFilters" class="tab-item-glass"
                    onclick="switchTab('filters')">
                    Filtros
                </button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto">
                <div id="routesContent" class="p-4 space-y-3"></div>
                <div id="poisContent" class="p-4 space-y-2 hidden"></div>
                <div id="filtersContent" class="p-4 hidden">
                    <div class="mb-5">
                        <h3 class="font-semibold mb-2 text-sm" data-i18n="filterRoutes" style="color:var(--text-primary);">Rutas</h3>
                        <div id="routeFilters" class="space-y-1"></div>
                    </div>
                    <div class="mb-5">
                        <h3 class="font-semibold mb-2 text-sm" data-i18n="filterPoiTypes" style="color:var(--text-primary);">Tipos de POI</h3>
                        <div id="poiFilters" class="space-y-1"></div>
                    </div>
                    <div class="mb-5">
                        <h3 class="font-semibold mb-2 text-sm" data-i18n="filterDifficulty" style="color:var(--text-primary);">Dificultad</h3>
                        <div id="difficultyFilters" class="space-y-1"></div>
                    </div>
                    <div class="mb-5">
                        <h3 class="font-semibold mb-2 text-sm" data-i18n="filterDistance" style="color:var(--text-primary);">Distancia</h3>
                        <div id="distanceFilters" class="space-y-1"></div>
                    </div>
                    <div class="mb-5">
                        <h3 class="font-semibold mb-2 text-sm" data-i18n="filterRouteType" style="color:var(--text-primary);">Tipo de ruta</h3>
                        <div id="typeFilters" class="space-y-1"></div>
                    </div>
                    <div class="mb-5">
                        <h3 class="font-semibold mb-2 text-sm" data-i18n="filterTags" style="color:var(--text-primary);">Etiquetas</h3>
                        <div id="tagFilters" class="flex flex-wrap gap-1"></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="resetFilters()"
                            class="btn-glass-secondary flex-1 py-2.5 px-3 text-sm touch-target" data-i18n="btnClean">
                            Limpiar
                        </button>
                        <button onclick="applyFilters()"
                            class="btn-glass-primary flex-1 py-2.5 px-3 text-sm touch-target" data-i18n="btnApply">
                            Aplicar
                        </button>
                    </div>
                </div>
                <div id="transportContent" class="p-4 hidden"></div>
            </div>

            <!-- Legend — Glass -->
            <div id="legend" style="background:rgba(255,255,255,0.4); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border-top:1px solid rgba(255,255,255,0.4);">
                <button onclick="toggleLegend()" id="legendToggleBtn" class="w-full flex items-center justify-between px-3 py-2 hover:opacity-80 transition" style="color:var(--text-muted);">
                    <h4 id="legendTitle" class="text-[10px] font-semibold uppercase m-0" style="color:var(--text-muted);">Leyenda</h4>
                    <svg id="legendChevron" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="legendCollapsible" class="px-3 pb-3 hidden">
                    <div id="legendItems" class="grid grid-cols-2 gap-1 text-xs"></div>
                </div>
            </div>

            <!-- Footer — Floating Glass Pill Bar -->
            <div class="bottom-bar-float">
                <button onclick="resetView()"
                    class="btn-glass-secondary flex-1 flex items-center justify-center gap-1.5 text-xs touch-target">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                    <span id="btnOverviewText">Vista general</span>
                </button>
                <button onclick="locateUser()"
                    class="btn-glass-primary flex items-center justify-center gap-1.5 text-xs px-4 touch-target">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <circle cx="12" cy="11" r="3" />
                    </svg>
                    <span id="btnLocationText">Mi ubicación</span>
                </button>
            </div>
        </aside>

        <!-- Map Container -->
        <div class="flex-1 relative">
            <div id="map" class="w-full h-full"></div>

            <!-- EU Funding Banner — Top Center -->
            <div class="absolute top-3 left-1/2 -translate-x-1/2 z-10 px-4 py-2" style="background:rgba(255,255,255,0.82); backdrop-filter:blur(20px) saturate(150%); -webkit-backdrop-filter:blur(20px) saturate(150%); border-radius:14px; border:1px solid rgba(255,255,255,0.5); box-shadow:0 4px 16px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.6); max-width:calc(100% - 24px);">
                <img src="assets/images/banner-fondos-europeos.svg" alt="Proyecto cofinanciado por fondos europeos" style="height:36px; width:auto; display:block; max-width:100%; object-fit:contain;">
            </div>

            <!-- Map Controls — Top Right (Satellite) -->
            <div class="absolute right-2 flex flex-col gap-2 z-10" style="top:110px;">
                <button onclick="toggleSatellite()" id="satelliteBtn"
                    class="map-control-glass flex items-center justify-center transition-all duration-200"
                    title="Vista satélite">
                    <svg id="satelliteBtnIcon" class="w-4 h-4" style="color:var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>

            <!-- Floating Buttons — Bottom Right (Weather + Transport) Apple Style -->
            <div class="absolute right-3 z-10 flex flex-col gap-2" style="bottom:40px;">
                <!-- Weather Button -->
                <div class="map-float-btn-wrapper" id="weatherFloatWrapper">
                    <button onclick="toggleWeatherPopup()" id="weatherFloatBtn" class="map-float-btn" title="Tiempo actual">
                        <span id="weatherFloatIcon" style="font-size:18px; line-height:1;">⛅</span>
                        <span id="weatherFloatTemp" style="font-size:11px; font-weight:700; color:var(--text-primary); line-height:1;"></span>
                    </button>
                    <!-- Weather Popup -->
                    <div id="weatherPopup" class="weather-popup hidden">
                        <div id="weatherWidget"></div>
                    </div>
                </div>
                <!-- Transport Button -->
                <button onclick="toggleTransportMarkers()" id="transportMapBtn"
                    class="map-float-btn"
                    title="Transporte público">
                    <span style="font-size:18px; line-height:1;">🚌</span>
                    <span style="font-size:9px; font-weight:600; color:var(--text-secondary); line-height:1;">Bus</span>
                </button>
                <!-- Info Button -->
                <button onclick="openInfoPanel()" id="infoMapBtn"
                    class="map-float-btn"
                    title="Información">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                    <span style="font-size:9px; font-weight:600; color:var(--text-secondary); line-height:1;">Info</span>
                </button>
            </div>

            <!-- CHANGE 3: Mobile sidebar toggle button -->
            <button id="sidebarToggleBtn" class="sidebar-toggle-btn fixed bottom-0 left-1/2 -translate-x-1/2 z-30 bg-white shadow-lg rounded-t-xl px-6 py-1.5 hidden" onclick="toggleSidebarMobile()" style="display:none;">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
            </button>

            <!-- Attribution — Glass -->
            <div class="absolute bottom-1 right-1 text-[10px] px-2 py-0.5 z-10" style="background:rgba(255,255,255,0.55); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border-radius:8px; border:1px solid rgba(255,255,255,0.4); color:var(--attribution-text);">
                © OpenStreetMap © CARTO
            </div>
        </div>
    </div>

    <!-- Route Detail Modal -->
    <div id="routeModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay" onclick="closeRouteModal()"></div>
        <div class="modal-content" id="modalContent"></div>
    </div>

    <!-- 360 Tour Modal -->
    <div id="tour360Modal" class="fixed inset-0 z-[60] hidden bg-black">
        <button onclick="close360Tour()"
            class="absolute top-4 right-4 z-10 w-12 h-12 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <iframe id="tour360Frame" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
    </div>

    <!-- Info Side Panel — Right Edge -->
    <div id="infoSideOverlay" class="info-side-overlay" onclick="closeInfoPanel()"></div>
    <div id="infoSidePanel" class="info-side-panel">
        <!-- Header -->
        <div class="relative shrink-0" style="background: linear-gradient(135deg, #5A9E8F, #1E3330);">
            <div class="p-5 pb-4 text-white">
                <button onclick="closeInfoPanel()" class="absolute top-3 right-3 w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition z-10">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
                <h2 id="infoPanelTitle" class="text-lg font-bold leading-tight mb-0.5" style="letter-spacing:-0.3px;">Vías Verdes de la Región de Murcia</h2>
                <p id="infoPanelSlogan" class="text-white/75 text-xs italic font-light">Vida en cada paso</p>
            </div>
        </div>

        <!-- Scrollable body -->
        <div class="flex-1 overflow-y-auto subtle-scrollbar">
            <!-- About -->
            <div class="p-5 pb-3">
                <p id="infoPanelDesc" class="text-[13px] leading-relaxed mb-4 font-light" style="color:var(--text-secondary);">Las Vías Verdes son antiguos trazados ferroviarios en desuso acondicionados como itinerarios ecoturísticos para senderistas y cicloturistas. Gracias a su accesibilidad, facilidad y seguridad, sin apenas pendientes y alejados del tráfico motorizado, son especialmente atractivos para cualquier persona que desee descubrir el entorno natural y el patrimonio cultural de las localidades y territorios que atraviesan.</p>

                <!-- Stats — Liquid Glass -->
                <div class="grid grid-cols-4 gap-2 mb-5">
                    <div class="glass-stat text-center p-2.5">
                        <div class="text-lg font-extrabold text-murcia" style="letter-spacing:-0.5px;">8</div>
                        <div id="infoStatRoutes" class="text-[9px] uppercase tracking-wider font-semibold" style="color:var(--text-muted);">Rutas</div>
                    </div>
                    <div class="glass-stat text-center p-2.5">
                        <div class="text-lg font-extrabold text-murcia" style="letter-spacing:-0.5px;">180+</div>
                        <div class="text-[9px] uppercase tracking-wider font-semibold" style="color:var(--text-muted);">km</div>
                    </div>
                    <div class="glass-stat text-center p-2.5">
                        <div class="text-lg font-extrabold text-murcia" style="letter-spacing:-0.5px;">4</div>
                        <div id="infoStatTours" class="text-[9px] uppercase tracking-wider font-semibold" style="color:var(--text-muted);">Tours 360</div>
                    </div>
                    <div class="glass-stat text-center p-2.5">
                        <div class="text-lg font-extrabold text-murcia" style="letter-spacing:-0.5px;">80+</div>
                        <div class="text-[9px] uppercase tracking-wider font-semibold" style="color:var(--text-muted);">POIs</div>
                    </div>
                </div>
            </div>

            <!-- Consorcio -->
            <div class="px-5 pb-4">
                <h3 id="infoPanelConsortium" class="text-[13px] font-bold text-murcia mb-2.5 flex items-center gap-2" style="letter-spacing:-0.2px;">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    Consorcio de las Vías Verdes de la Región de Murcia
                </h3>
                <div class="glass-stat rounded-xl p-3.5 space-y-2 text-[13px] font-light" style="color:var(--text-secondary);">
                    <p class="flex items-start gap-2">
                        <svg class="w-3.5 h-3.5 text-murcia mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><circle cx="12" cy="11" r="3"/></svg>
                        <span>Oficina Noroeste: Antigua Estación del Tren, Camino de la Estación s/n, 30400 Caravaca de la Cruz (Murcia)</span>
                    </p>
                    <p class="flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                        <span class="font-medium">868 185 185</span>
                    </p>
                    <p class="flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        <span>info@viasverdesregiondemurcia.es</span>
                    </p>
                    <p class="flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></svg>
                        <a href="https://viasverdesregiondemurcia.es" target="_blank" class="text-murcia hover:underline font-medium">viasverdesregiondemurcia.es</a>
                    </p>
                </div>
            </div>

            <!-- Informacion Practica (Accordion) -->
            <div class="px-5 pb-4">
                <h3 id="infoPanelPractical" class="text-[13px] font-bold text-murcia mb-2.5 flex items-center gap-2" style="letter-spacing:-0.2px;">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Información Práctica
                </h3>
                <div class="space-y-1">
                    <div class="info-accordion-item overflow-hidden" style="border:1px solid rgba(255,255,255,0.5); border-radius:12px; background:rgba(255,255,255,0.4); backdrop-filter:blur(8px);">
                        <button onclick="toggleInfoAccordion(this)" class="w-full flex items-center justify-between p-2.5 text-[13px] font-semibold transition touch-target" style="color:var(--text-primary);">
                            <span data-i18n="howToGet">¿Cómo llegar?</span>
                            <svg class="w-3.5 h-3.5 text-slate-400 transition-transform duration-200 info-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="info-accordion-content hidden px-2.5 pb-2.5 text-[13px] leading-relaxed font-light" style="color:var(--text-secondary);" data-i18n-content="howToGetDesc">
                            Las Vías Verdes de Murcia son accesibles en coche desde las principales autovías de la región (A-30, A-7, RM-15). La mayoría de puntos de inicio cuentan con aparcamiento. También se puede llegar en transporte público: Cercanías RENFE conecta con las estaciones de Totana y Águilas, y autobuses interurbanos llegan a Caravaca, Cieza, Yecla y otros núcleos.
                        </div>
                    </div>
                    <div class="info-accordion-item overflow-hidden" style="border:1px solid rgba(255,255,255,0.5); border-radius:12px; background:rgba(255,255,255,0.4); backdrop-filter:blur(8px);">
                        <button onclick="toggleInfoAccordion(this)" class="w-full flex items-center justify-between p-2.5 text-[13px] font-semibold transition touch-target" style="color:var(--text-primary);">
                            <span data-i18n="bestSeason">Mejor época</span>
                            <svg class="w-3.5 h-3.5 text-slate-400 transition-transform duration-200 info-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="info-accordion-content hidden px-2.5 pb-2.5 text-[13px] leading-relaxed font-light" style="color:var(--text-secondary);" data-i18n-content="bestSeasonDesc">
                            Primavera (febrero-mayo) y otoño (octubre-noviembre) son las estaciones ideales. En marzo, la Floración de Cieza tiñe los campos de rosa y blanco con la florescencia de melocotoneros, ciruelos y almendros. Evitar las horas centrales del día en verano (junio-septiembre) por las altas temperaturas.
                        </div>
                    </div>
                    <div class="info-accordion-item overflow-hidden" style="border:1px solid rgba(255,255,255,0.5); border-radius:12px; background:rgba(255,255,255,0.4); backdrop-filter:blur(8px);">
                        <button onclick="toggleInfoAccordion(this)" class="w-full flex items-center justify-between p-2.5 text-[13px] font-semibold transition touch-target" style="color:var(--text-primary);">
                            <span data-i18n="equipment">Equipamiento recomendado</span>
                            <svg class="w-3.5 h-3.5 text-slate-400 transition-transform duration-200 info-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="info-accordion-content hidden px-2.5 pb-2.5 text-[13px] leading-relaxed font-light" style="color:var(--text-secondary);" data-i18n-content="equipmentDesc">
                            Calzado cómodo (deportivo o botas de senderismo), agua suficiente (mínimo 1L por persona), protección solar (crema, gorra, gafas de sol), y casco si vas en bicicleta. Recomendable llevar linterna para los túneles más largos y un kit básico de reparación para bicicletas.
                        </div>
                    </div>
                    <div class="info-accordion-item overflow-hidden" style="border:1px solid rgba(255,255,255,0.5); border-radius:12px; background:rgba(255,255,255,0.4); backdrop-filter:blur(8px);">
                        <button onclick="toggleInfoAccordion(this)" class="w-full flex items-center justify-between p-2.5 text-[13px] font-semibold transition touch-target" style="color:var(--text-primary);">
                            <span data-i18n="rules">Normas de uso</span>
                            <svg class="w-3.5 h-3.5 text-slate-400 transition-transform duration-200 info-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="info-accordion-content hidden px-2.5 pb-2.5 text-[13px] leading-relaxed font-light" style="color:var(--text-secondary);" data-i18n-content="rulesDesc">
                            Prioridad al peatón frente a ciclistas. Perros siempre con correa. No salirse del camino señalizado. Llevarse toda la basura generada. No hacer fuego. Respetar la flora y fauna del entorno. Circular por la derecha y avisar antes de adelantar. En túneles, utilizar iluminación.
                        </div>
                    </div>
                    <div class="info-accordion-item overflow-hidden" style="border:1px solid rgba(255,255,255,0.5); border-radius:12px; background:rgba(255,255,255,0.4); backdrop-filter:blur(8px);">
                        <button onclick="toggleInfoAccordion(this)" class="w-full flex items-center justify-between p-2.5 text-[13px] font-semibold transition touch-target" style="color:var(--text-primary);">
                            <span data-i18n="hostels">Albergues</span>
                            <svg class="w-3.5 h-3.5 text-slate-400 transition-transform duration-200 info-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="info-accordion-content hidden px-2.5 pb-2.5 text-[13px] leading-relaxed font-light" style="color:var(--text-secondary);" data-i18n-content="hostelsDesc">
                            La Vía Verde del Noroeste cuenta con una red de albergues en antiguas estaciones restauradas: Alguazas, Campos del Río, Albudeite, La Luz, La Rafa y Cehegín, con parada final en la Estación de Caravaca. Ofrecen alojamiento básico, cantina y punto de información. Reservas a través del Consorcio o en cada establecimiento.
                        </div>
                    </div>
                </div>
            </div>

                <!-- Enlaces Utiles -->
                <div class="px-5 pb-4">
                    <h3 id="infoPanelLinks" class="text-[13px] font-bold text-murcia mb-2.5 flex items-center gap-2" style="letter-spacing:-0.2px;">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                        Enlaces Útiles
                    </h3>
                    <div class="space-y-1.5">
                        <a href="https://viasverdesregiondemurcia.es" target="_blank" class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg text-[12px] text-slate-700 hover:bg-murcia/5 hover:text-murcia transition font-medium">
                            <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                            viasverdesregiondemurcia.es
                        </a>
                        <a href="https://turismoregiondemurcia.es/es/vias_verdes/" target="_blank" class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg text-[12px] text-slate-700 hover:bg-murcia/5 hover:text-murcia transition font-medium">
                            <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                            turismoregiondemurcia.es/vias_verdes
                        </a>
                        <a href="https://viaverdecampocartagena.com" target="_blank" class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg text-[12px] text-slate-700 hover:bg-murcia/5 hover:text-murcia transition font-medium">
                            <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                            viaverdecampocartagena.com
                        </a>
                        <a href="https://viaverdemazarron.com" target="_blank" class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg text-[12px] text-slate-700 hover:bg-murcia/5 hover:text-murcia transition font-medium">
                            <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                            viaverdemazarron.com
                        </a>
                        <a href="https://viaverdedelnoroeste.com" target="_blank" class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg text-[12px] text-slate-700 hover:bg-murcia/5 hover:text-murcia transition font-medium">
                            <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                            viaverdedelnoroeste.com
                        </a>
                        <a href="https://viaverdealmendricos.com" target="_blank" class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg text-[12px] text-slate-700 hover:bg-murcia/5 hover:text-murcia transition font-medium">
                            <svg class="w-3.5 h-3.5 text-murcia flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                            viaverdealmendricos.com
                        </a>
                    </div>
                </div>

                <!-- Logos Institucionales -->
                <div class="px-5 pb-5">
                    <h3 id="infoPanelInstitutions" class="text-[13px] font-bold text-murcia mb-2.5 flex items-center gap-2" style="letter-spacing:-0.2px;">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/></svg>
                        Instituciones Colaboradoras
                    </h3>
                    <div class="flex items-center justify-center gap-3 flex-wrap p-3 bg-slate-50 rounded-xl">
                        <div class="flex flex-col items-center gap-0.5">
                            <div class="w-12 h-12 bg-white rounded-lg shadow-sm border border-slate-100 flex items-center justify-center p-1">
                                <svg viewBox="0 0 40 40" class="w-full h-full"><rect width="40" height="40" rx="4" fill="#5A9E8F" opacity="0.1"/><text x="20" y="16" text-anchor="middle" font-size="7" font-weight="700" fill="#5A9E8F">REGION</text><text x="20" y="24" text-anchor="middle" font-size="6" font-weight="500" fill="#5A9E8F">DE</text><text x="20" y="32" text-anchor="middle" font-size="7" font-weight="700" fill="#5A9E8F">MURCIA</text></svg>
                            </div>
                            <span class="text-[7px] text-slate-400 text-center leading-tight font-medium">Región de<br>Murcia</span>
                        </div>
                        <div class="flex flex-col items-center gap-0.5">
                            <div class="w-12 h-12 bg-white rounded-lg shadow-sm border border-slate-100 flex items-center justify-center p-1">
                                <svg viewBox="0 0 40 40" class="w-full h-full"><rect width="40" height="40" rx="4" fill="#0EA5E9" opacity="0.1"/><text x="20" y="16" text-anchor="middle" font-size="6" font-weight="700" fill="#0EA5E9">COSTA</text><text x="20" y="26" text-anchor="middle" font-size="7" font-weight="700" fill="#0EA5E9">CÁLIDA</text><path d="M10 32 Q20 28 30 32" fill="none" stroke="#0EA5E9" stroke-width="1.5"/></svg>
                            </div>
                            <span class="text-[7px] text-slate-400 text-center leading-tight font-medium">Costa<br>Cálida</span>
                        </div>
                        <div class="flex flex-col items-center gap-0.5">
                            <div class="w-12 h-12 bg-white rounded-lg shadow-sm border border-slate-100 flex items-center justify-center p-1">
                                <svg viewBox="0 0 40 40" class="w-full h-full"><rect width="40" height="40" rx="4" fill="#22c55e" opacity="0.1"/><text x="20" y="14" text-anchor="middle" font-size="6" font-weight="700" fill="#22c55e">VÍAS</text><text x="20" y="24" text-anchor="middle" font-size="7" font-weight="700" fill="#22c55e">VERDES</text><circle cx="20" cy="32" r="3" fill="#22c55e" opacity="0.5"/></svg>
                            </div>
                            <span class="text-[7px] text-slate-400 text-center leading-tight font-medium">Vías Verdes<br>Consorcio</span>
                        </div>
                        <div class="flex flex-col items-center gap-0.5">
                            <div class="w-12 h-12 bg-white rounded-lg shadow-sm border border-slate-100 flex items-center justify-center p-1">
                                <svg viewBox="0 0 40 40" class="w-full h-full"><rect width="40" height="40" rx="4" fill="#92400E" opacity="0.1"/><text x="20" y="14" text-anchor="middle" font-size="5" font-weight="700" fill="#92400E">CAMINOS</text><text x="20" y="24" text-anchor="middle" font-size="5" font-weight="700" fill="#92400E">NATURALES</text><path d="M12 30 L20 28 L28 30" fill="none" stroke="#92400E" stroke-width="1.5"/></svg>
                            </div>
                            <span class="text-[7px] text-slate-400 text-center leading-tight font-medium">Caminos<br>Naturales</span>
                        </div>
                        <div class="flex flex-col items-center gap-0.5">
                            <div class="w-12 h-12 bg-white rounded-lg shadow-sm border border-slate-100 flex items-center justify-center p-1">
                                <svg viewBox="0 0 40 40" class="w-full h-full"><rect width="40" height="40" rx="4" fill="#2563EB" opacity="0.1"/><circle cx="14" cy="16" r="5" fill="none" stroke="#FCD34D" stroke-width="1.5"/><text x="14" y="18" text-anchor="middle" font-size="5" font-weight="700" fill="#FCD34D">EU</text><text x="28" y="16" text-anchor="middle" font-size="5" font-weight="700" fill="#2563EB">FEDER</text><text x="20" y="28" text-anchor="middle" font-size="4" font-weight="500" fill="#2563EB">Unión</text><text x="20" y="34" text-anchor="middle" font-size="4" font-weight="500" fill="#2563EB">Europea</text></svg>
                            </div>
                            <span class="text-[7px] text-slate-400 text-center leading-tight font-medium">FEDER / Unión<br>Europea</span>
                        </div>
                    </div>
                </div>

                <!-- Footer credit -->
                <div class="px-5 pb-5 text-center">
                    <p id="infoPanelCredit" class="text-[9px] text-slate-400 font-light">Mapa interactivo desarrollado con datos del Consorcio de Vías Verdes de la Región de Murcia</p>
                </div>
            </div>
        </div>

    <script>
        // ==================== VÍAS VERDES DE MURCIA v1.2 - MAPLIBRE (GRATUITO) ====================

        // ==================== i18n — INTERNATIONALIZATION ====================
        let currentLang = localStorage.getItem('vv_lang') || 'es';

        const I18N = {
            es: {
                // Header
                appTitle: 'Vías Verdes Región de Murcia',
                appSubtitle: '8 rutas · 180+ km · Tours 360°',
                searchPlaceholder: 'Buscar ruta o punto...',
                // Tabs
                tabRoutes: 'Rutas',
                tabPois: 'POIs',
                tabFilters: 'Filtros',
                // Filter sections
                filterRoutes: 'Rutas',
                filterPoiTypes: 'Tipos de POI',
                filterDifficulty: 'Dificultad',
                filterDistance: 'Distancia',
                filterRouteType: 'Tipo de ruta',
                filterStatus: 'Estado',
                filterTags: 'Etiquetas',
                btnClean: 'Limpiar',
                btnApply: 'Aplicar',
                // Legend
                legend: 'Leyenda',
                // Footer bar
                btnOverview: 'Vista general',
                btnMyLocation: 'Mi ubicación',
                btnInfo: 'Info',
                // Loader
                loadingMsg: 'Cargando mapa interactivo...',
                // Map controls
                satellite: 'Vista satélite',
                weather: 'Tiempo actual',
                transport: 'Transporte público',
                // Route detail modal
                elevation: 'Perfil altimétrico',
                itinerary: 'Itinerario',
                access: 'Acceso',
                openRoute: 'Ver ruta',
                tour360: 'Tour 360°',
                downloadGPX: 'GPX',
                distance: 'Distancia',
                duration: 'Duración',
                difficulty: 'Dificultad',
                surface: 'Superficie',
                startPoint: 'Inicio',
                endPoint: 'Final',
                // Difficulty
                easy: 'Fácil',
                medium: 'Media',
                hard: 'Difícil',
                // Status
                operational: 'Operativa',
                comingSoon: 'Próximamente',
                // Type
                linear: 'Lineal',
                circular: 'Circular',
                // POI types
                poiMirador: 'Mirador',
                poiTunel: 'Túnel',
                poiEstacion: 'Estación',
                poiPatrimonio: 'Patrimonio',
                poiServicio: 'Servicio',
                poiPlaya: 'Playa',
                poiPuente: 'Puente',
                poiPanel: 'Panel Info',
                poiPrecaucion: 'Precaución',
                poiAlbergue: 'Albergue',
                poiAreaDescanso: 'Área Descanso',
                poiPueblo: 'Pueblo',
                poiRestaurante: 'Restaurante',
                poiAparcamiento: 'Aparcamiento',
                poiFuente: 'Fuente de Agua',
                poiCamping: 'Camping',
                poiCentroSalud: 'Centro Salud',
                // Info modal
                infoTitle: 'Vías Verdes de la Región de Murcia',
                infoSlogan: 'Vida en cada paso',
                infoDesc: 'Las Vías Verdes son antiguos trazados ferroviarios en desuso acondicionados como itinerarios ecoturísticos para senderistas y cicloturistas. Gracias a su accesibilidad, facilidad y seguridad, sin apenas pendientes y alejados del tráfico motorizado, son especialmente atractivos para cualquier persona que desee descubrir el entorno natural y el patrimonio cultural de las localidades y territorios que atraviesan.',
                infoRoutes: 'Rutas',
                infoKm: 'km',
                infoTours: 'Tours 360',
                infoPois: 'POIs',
                consortium: 'Consorcio de las Vías Verdes de la Región de Murcia',
                practicalInfo: 'Información Práctica',
                howToGet: '¿Cómo llegar?',
                howToGetDesc: 'Las Vías Verdes de Murcia son accesibles en coche desde las principales autovías de la región (A-30, A-7, RM-15). La mayoría de puntos de inicio cuentan con aparcamiento. También se puede llegar en transporte público: Cercanías RENFE conecta con las estaciones de Totana y Águilas, y autobuses interurbanos llegan a Caravaca, Cieza, Yecla y otros núcleos.',
                bestSeason: 'Mejor época',
                bestSeasonDesc: 'Primavera (febrero-mayo) y otoño (octubre-noviembre) son las estaciones ideales. En marzo, la Floración de Cieza tiñe los campos de rosa y blanco con la florescencia de melocotoneros, ciruelos y almendros. Evitar las horas centrales del día en verano (junio-septiembre) por las altas temperaturas.',
                equipment: 'Equipamiento recomendado',
                equipmentDesc: 'Calzado cómodo (deportivo o botas de senderismo), agua suficiente (mínimo 1L por persona), protección solar (crema, gorra, gafas de sol), y casco si vas en bicicleta. Recomendable llevar linterna para los túneles más largos y un kit básico de reparación para bicicletas.',
                rules: 'Normas de uso',
                rulesDesc: 'Prioridad al peatón frente a ciclistas. Perros siempre con correa. No salirse del camino señalizado. Llevarse toda la basura generada. No hacer fuego. Respetar la flora y fauna del entorno. Circular por la derecha y avisar antes de adelantar. En túneles, utilizar iluminación.',
                hostels: 'Albergues',
                hostelsDesc: 'La Vía Verde del Noroeste cuenta con una red de albergues en antiguas estaciones restauradas: Alguazas, Campos del Río, Albudeite, La Luz, La Rafa y Cehegín, con parada final en la Estación de Caravaca. Ofrecen alojamiento básico, cantina y punto de información. Reservas a través del Consorcio o en cada establecimiento.',
                usefulLinks: 'Enlaces Útiles',
                institutions: 'Instituciones Colaboradoras',
                footerCredit: 'Mapa interactivo desarrollado con datos del Consorcio de Vías Verdes de la Región de Murcia',
                // Route cards
                byBike: 'en bici',
                onFoot: 'a pie',
                profileSoft: 'Suave',
            },
            en: {
                // Header
                appTitle: 'Greenways of the Region of Murcia',
                appSubtitle: '8 routes · 180+ km · 360° Tours',
                searchPlaceholder: 'Search route or point...',
                // Tabs
                tabRoutes: 'Routes',
                tabPois: 'POIs',
                tabFilters: 'Filters',
                // Filter sections
                filterRoutes: 'Routes',
                filterPoiTypes: 'POI Types',
                filterDifficulty: 'Difficulty',
                filterDistance: 'Distance',
                filterRouteType: 'Route Type',
                filterStatus: 'Status',
                filterTags: 'Tags',
                btnClean: 'Clear',
                btnApply: 'Apply',
                // Legend
                legend: 'Legend',
                // Footer bar
                btnOverview: 'Overview',
                btnMyLocation: 'My location',
                btnInfo: 'Info',
                // Loader
                loadingMsg: 'Loading interactive map...',
                // Map controls
                satellite: 'Satellite view',
                weather: 'Current weather',
                transport: 'Public transport',
                // Route detail modal
                elevation: 'Elevation profile',
                itinerary: 'Itinerary',
                access: 'Access',
                openRoute: 'View route',
                tour360: '360° Tour',
                downloadGPX: 'GPX',
                distance: 'Distance',
                duration: 'Duration',
                difficulty: 'Difficulty',
                surface: 'Surface',
                startPoint: 'Start',
                endPoint: 'End',
                // Difficulty
                easy: 'Easy',
                medium: 'Medium',
                hard: 'Hard',
                // Status
                operational: 'Operational',
                comingSoon: 'Coming soon',
                // Type
                linear: 'Linear',
                circular: 'Circular',
                // POI types
                poiMirador: 'Viewpoint',
                poiTunel: 'Tunnel',
                poiEstacion: 'Station',
                poiPatrimonio: 'Heritage',
                poiServicio: 'Service',
                poiPlaya: 'Beach',
                poiPuente: 'Bridge',
                poiPanel: 'Info Panel',
                poiPrecaucion: 'Caution',
                poiAlbergue: 'Hostel',
                poiAreaDescanso: 'Rest Area',
                poiPueblo: 'Village',
                poiRestaurante: 'Restaurant',
                poiAparcamiento: 'Parking',
                poiFuente: 'Drinking Water',
                poiCamping: 'Camping',
                poiCentroSalud: 'Health Center',
                // Info modal
                infoTitle: 'Greenways of the Region of Murcia',
                infoSlogan: 'Life in every step',
                infoDesc: 'Greenways are former disused railway routes converted into eco-tourism trails for hikers and cyclists. Thanks to their accessibility, ease and safety, with barely any slopes and away from motor traffic, they are especially attractive for anyone who wishes to discover the natural environment and cultural heritage of the towns and territories they pass through.',
                infoRoutes: 'Routes',
                infoKm: 'km',
                infoTours: '360 Tours',
                infoPois: 'POIs',
                consortium: 'Consortium of the Greenways of the Region of Murcia',
                practicalInfo: 'Practical Information',
                howToGet: 'How to get there?',
                howToGetDesc: 'The Murcia Greenways are accessible by car from the main motorways (A-30, A-7, RM-15). Most starting points have parking. You can also arrive by public transport: RENFE Cercanías connects with Totana and Águilas stations, and intercity buses reach Caravaca, Cieza, Yecla and other towns.',
                bestSeason: 'Best season',
                bestSeasonDesc: 'Spring (February–May) and autumn (October–November) are ideal. In March, the Cieza Blossom Festival paints the fields pink and white with peach, plum and almond blossoms. Avoid midday in summer (June–September) due to high temperatures.',
                equipment: 'Recommended equipment',
                equipmentDesc: 'Comfortable footwear (trainers or hiking boots), enough water (minimum 1L per person), sun protection (sunscreen, cap, sunglasses), and a helmet if cycling. A torch is recommended for longer tunnels and a basic repair kit for bicycles.',
                rules: 'Rules of use',
                rulesDesc: 'Pedestrians have priority over cyclists. Dogs must always be on a lead. Stay on the marked path. Take all rubbish with you. No fires. Respect the flora and fauna. Keep to the right and signal before overtaking. Use lighting in tunnels.',
                hostels: 'Hostels',
                hostelsDesc: 'The Northwest Greenway has a network of hostels in restored old stations: Alguazas, Campos del Río, Albudeite, La Luz, La Rafa and Cehegín, with a final stop at Caravaca Station. They offer basic accommodation, a canteen and an information point. Bookings through the Consortium or at each establishment.',
                usefulLinks: 'Useful Links',
                institutions: 'Partner Institutions',
                footerCredit: 'Interactive map developed with data from the Consortium of Greenways of the Region of Murcia',
                // Route cards
                byBike: 'by bike',
                onFoot: 'on foot',
                profileSoft: 'Gentle',
            }
        };

        function t(key) {
            return (I18N[currentLang] && I18N[currentLang][key]) || (I18N.es[key]) || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('vv_lang', lang);
            document.documentElement.lang = lang;
            // Update lang toggle buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            // Re-render all translateable static elements
            applyStaticTranslations();
            // Re-render dynamic content
            if (routesData && poisData) {
                renderRoutesList();
                renderPOIsList();
                initFilters();
            }
        }

        function applyStaticTranslations() {
            // Header
            const titleEl = document.getElementById('headerTitle');
            const subtitleEl = document.getElementById('headerSubtitle');
            if (titleEl) titleEl.textContent = t('appTitle');
            if (subtitleEl) subtitleEl.textContent = t('appSubtitle');
            // Search
            const searchEl = document.getElementById('searchInput');
            if (searchEl) searchEl.placeholder = t('searchPlaceholder');
            // Tabs
            const tabR = document.getElementById('tabRoutes');
            const tabP = document.getElementById('tabPOIs');
            const tabF = document.getElementById('tabFilters');
            if (tabR) tabR.textContent = t('tabRoutes');
            if (tabP) tabP.textContent = t('tabPois');
            if (tabF) tabF.textContent = t('tabFilters');
            // Filter headings
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                el.textContent = t(key);
            });
            // Legend
            const legendTitle = document.getElementById('legendTitle');
            if (legendTitle) legendTitle.textContent = t('legend');
            // Footer buttons
            const btnOverview = document.getElementById('btnOverviewText');
            const btnLocation = document.getElementById('btnLocationText');
            if (btnOverview) btnOverview.textContent = t('btnOverview');
            if (btnLocation) btnLocation.textContent = t('btnMyLocation');
            // Loader
            const loaderMsg = document.getElementById('loaderMsg');
            if (loaderMsg) loaderMsg.textContent = t('loadingMsg');
        }

        // ==================== STATE ====================
        let map, markers = [], isSatellite = false;
        let kmMarkers = [];
        let activeFilters = {
            routes: [], poiTypes: [], difficulties: [],
            distances: ['<10', '10-30', '30-50', '>50'],
            types: ['lineal', 'circular'],
            statuses: ['operational', 'coming_soon'],
            tags: []
        };
        let routesData = null;
        let poisData = null;
        let deferredInstallPrompt = null;

        // CHANGE 3: Mobile sidebar state
        let sidebarExpanded = false;

        // ==================== CONFIG ====================
        const APP_CONFIG = {
            center: [-1.35, 37.85],
            zoom: 8,
            styles: {
                light: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json'
            }
        };

        const DISTANCE_RANGES = {
            '<10': { label: '< 10 km', min: 0, max: 10, color: '#22c55e' },
            '10-30': { label: '10-30 km', min: 10, max: 30, color: '#f59e0b' },
            '30-50': { label: '30-50 km', min: 30, max: 50, color: '#f97316' },
            '>50': { label: '> 50 km', min: 50, max: 9999, color: '#ef4444' }
        };

        const TYPE_CONFIG = {
            'lineal': { label: 'Lineal', icon: '→' },
            'circular': { label: 'Circular', icon: '↻' }
        };

        const STATUS_CONFIG = {};

        const POI_CONFIG = {
            mirador: { color: '#F59E0B', label: 'Mirador', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8-10-8-10-8z"/></svg>' },
            tunel: { color: '#6B7280', label: 'Túnel', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16M4 20V10a8 8 0 1116 0v10"/></svg>' },
            estacion: { color: '#5A9E8F', label: 'Estación', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="3" width="16" height="16" rx="2"/><path d="M12 19v2M8 7h8"/></svg>' },
            patrimonio: { color: '#92400E', label: 'Patrimonio', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l7-4 7 4v14"/></svg>' },
            puente: { color: '#D97706', label: 'Puente', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16h16M6 8h12M8 8v8M16 8v8M12 8v8"/></svg>' },
            albergue: { color: '#059669', label: 'Albergue', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/></svg>' },
            alojamiento: { color: '#7C3AED', label: 'Alojamiento', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0H5m14 0h2m-16 0H3M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 4v4h4v-4"/></svg>' },
            area_descanso: { color: '#84CC16', label: 'Área Descanso', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>' },
            pueblo: { color: '#8B5CF6', label: 'Pueblo', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-6h2l-7-7-7 7h2v6"/><path d="M9 21v-4h2v4"/></svg>' },
            restaurante: { color: '#E11D48', label: 'Restaurante', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8zM6 1v3M10 1v3M14 1v3"/></svg>' },
            aparcamiento: { color: '#2563EB', label: 'Aparcamiento', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M9 17V7h4a3 3 0 010 6H9"/></svg>' },
            centro_salud: { color: '#E11D48', label: 'Centro Salud', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6v12M6 12h12"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg>' },
            comisaria: { color: '#1E40AF', label: 'Comisaría', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M9 21V11l3-6 3 6v10M6 21V14h3M15 21V14h3M12 8v1"/><circle cx="12" cy="5" r="1"/></svg>' },
            farmacia: { color: '#16A34A', label: 'Farmacia', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M12 8v8M8 12h8"/></svg>' },
            supermercado: { color: '#EA580C', label: 'Supermercado', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>' },
            oficina_turismo: { color: '#0891B2', label: 'Of. Turismo', svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>' }
        };

        const DIFFICULTY = {
            'fácil': { color: '#5A9E8F', label: 'Fácil', class: 'badge-easy' },
            'media': { color: '#f59e0b', label: 'Media', class: 'badge-medium' },
            'difícil': { color: '#ef4444', label: 'Difícil', class: 'badge-hard' }
        };

        // ==================== TIME PARSER & FORMATTER ====================
        function formatDuration(min) {
            if (!min || min <= 0) return '--';
            const h = Math.floor(min / 60);
            const m = min % 60;
            if (h === 0) return `${m} min`;
            if (m === 0) return `${h}h`;
            return `${h}h ${m}m`;
        }
        function parseTimeToMinutes(timeStr) {
            if (!timeStr) return 120;
            // "4-5h bici" → avg 4.5h → 270min
            // "1.5h bici" → 90min
            // "45m bici" → 45min
            // "20m a pie" → 20min
            const str = timeStr.toLowerCase();
            if (str.includes('h')) {
                const match = str.match(/([\d.]+)(?:-([\d.]+))?h/);
                if (match) {
                    const low = parseFloat(match[1]);
                    const high = match[2] ? parseFloat(match[2]) : low;
                    return Math.round(((low + high) / 2) * 60);
                }
            }
            if (str.includes('m')) {
                const match = str.match(/([\d.]+)m/);
                if (match) return Math.round(parseFloat(match[1]));
            }
            return parseInt(timeStr) * 60 || 120;
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Data safely
                if (typeof viasVerdes !== 'undefined') {
                    routesData = {
                        "type": "FeatureCollection",
                        "features": viasVerdes.map(v => ({
                            "type": "Feature",
                            "properties": {
                                "id_ruta": v.id,
                                "nombre": v.name,
                                "descripcion_corta": v.desc,
                                "dificultad": v.diff === 'easy' ? 'fácil' : (v.diff === 'medium' ? 'media' : 'difícil'),
                                "distancia_km": parseFloat(v.km),
                                "tiempo_estimado_min": parseTimeToMinutes(v.time),
                                "superficie": "mixto",
                                "color": v.color.main,
                                "url_tour_360": v.url360 || "",
                                "perfil_elevacion": v.type || "suave",
                                "image": v.image || ""
                            },
                            "geometry": {
                                "type": "LineString",
                                "coordinates": v.coords || []
                            }
                        }))
                    };
                } else {
                    console.error("viasVerdes data not found!");
                    routesData = { "type": "FeatureCollection", "features": [] };
                }

                // Generar POIs dinamicamente usando interpolacion de coordenadas sobre las rutas
                if (typeof generateAllPois === 'function') {
                    poisData = {
                        "type": "FeatureCollection",
                        "features": generateAllPois()
                    };
                    console.log('POIs generados:', poisData.features.length);
                } else {
                    console.warn('pois.js no cargado, usando POIs vacios');
                    poisData = { "type": "FeatureCollection", "features": [] };
                }

                // CHANGE 1: Removed initDarkMode() call

                await initMap();
                await loadBoundary();
                initFilters();
                renderUI();

                // Apply saved language on init
                if (currentLang !== 'es') {
                    document.querySelectorAll('.lang-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.lang === currentLang);
                    });
                }
                applyStaticTranslations();

                // Weather module init (async, non-blocking)
                initWeather();

                // Transport module init (async, non-blocking)
                if (typeof initTransport === 'function') initTransport();

                // CHANGE 3: Check mobile layout on init
                checkMobileLayout();

                // Registrar Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').then(reg => {
                        console.log('Service Worker registrado:', reg.scope);
                    }).catch(err => console.log('SW no disponible:', err));
                }

                // Escuchar evento de instalacion PWA
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredInstallPrompt = e;
                    const banner = document.getElementById('installBanner');
                    if (banner) banner.classList.remove('hidden');
                });
            } catch (e) {
                console.error("Initialization error:", e);
            } finally {
                hideLoader();
            }
        });

        // CHANGE 2: Only light style for initial map load
        async function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: APP_CONFIG.styles.light,
                center: APP_CONFIG.center,
                zoom: APP_CONFIG.zoom,
                attributionControl: false
            });

            // Wait for map load with a safety timeout
            await Promise.race([
                new Promise(r => map.on('load', r)),
                new Promise(r => setTimeout(r, 5000)) // Force continue after 5 seconds
            ]);

            map.addControl(new maplibregl.NavigationControl(), 'top-right');
        }

        async function loadBoundary() {
            // Si ya tenemos el boundary cacheado, reutilizar sin fetch
            if (cachedMurciaBoundary) {
                addBoundaryMask(cachedMurciaBoundary);
                return;
            }
            try {
                const response = await fetch('https://nominatim.openstreetmap.org/search?q=Región de Murcia,Spain&format=json&polygon_geojson=1&limit=1', { headers: { 'User-Agent': 'ViasVerdesMurcia/1.0' } });
                const data = await response.json();
                if (data?.[0]?.geojson) {
                    const geojson = data[0].geojson;
                    const boundary = geojson.type === 'Polygon' ? geojson.coordinates[0] : geojson.coordinates.reduce((a, b) => b[0].length > a.length ? b[0] : a, []);
                    addBoundaryMask(boundary);
                }
            } catch (e) { console.log('Using fallback boundary'); }
        }

        let cachedMurciaBoundary = null;

        // CHANGE 1: Removed isDarkMode conditionals from addBoundaryMask
        function addBoundaryMask(murciaBoundary) {
            if (!murciaBoundary) return;
            cachedMurciaBoundary = murciaBoundary;
            const world = [[-180, 90], [180, 90], [180, -90], [-180, -90], [-180, 90]];

            // Eliminar capas y fuentes existentes si hay (para re-creacion tras cambio de estilo)
            ['mask-fill', 'murcia-highlight', 'boundary-stroke', 'boundary-glow'].forEach(id => {
                if (map.getLayer(id)) map.removeLayer(id);
            });
            ['mask', 'murcia-region', 'boundary-line'].forEach(id => {
                if (map.getSource(id)) map.removeSource(id);
            });

            // Mascara: oscurecer todo fuera de Murcia
            map.addSource('mask', {
                type: 'geojson',
                data: { type: 'Feature', geometry: { type: 'Polygon', coordinates: [world, murciaBoundary] } }
            });
            map.addLayer({
                id: 'mask-fill', type: 'fill', source: 'mask',
                paint: { 'fill-color': '#334155', 'fill-opacity': 0.3 }
            });

            // Highlight: relleno sutil dentro de Murcia
            map.addSource('murcia-region', {
                type: 'geojson',
                data: { type: 'Feature', geometry: { type: 'Polygon', coordinates: [murciaBoundary] } }
            });
            map.addLayer({
                id: 'murcia-highlight', type: 'fill', source: 'murcia-region',
                paint: { 'fill-color': '#5A9E8F', 'fill-opacity': 0.06 }
            });

            // Borde de la region - glow
            map.addSource('boundary-line', {
                type: 'geojson',
                data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [...murciaBoundary, murciaBoundary[0]] } }
            });
            map.addLayer({
                id: 'boundary-glow', type: 'line', source: 'boundary-line',
                paint: { 'line-color': '#5A9E8F', 'line-width': 6, 'line-opacity': 0.25, 'line-blur': 4 }
            });
            map.addLayer({
                id: 'boundary-stroke', type: 'line', source: 'boundary-line',
                paint: { 'line-color': '#5A9E8F', 'line-width': 2.5, 'line-opacity': 0.7 }
            });
        }

        function initFilters() {
            activeFilters.routes = routesData.features.map(f => f.properties.id_ruta);
            activeFilters.poiTypes = Object.keys(POI_CONFIG);
            activeFilters.difficulties = Object.keys(DIFFICULTY);
            activeFilters.distances = Object.keys(DISTANCE_RANGES);
            activeFilters.types = Object.keys(TYPE_CONFIG);
            // Recopilar todas las etiquetas unicas
            const allTags = new Set();
            viasVerdes.forEach(v => { if (v.tags) v.tags.forEach(t => allTags.add(t)); });
            activeFilters.tags = Array.from(allTags);
        }

        function hideLoader() {
            const loader = document.getElementById('loader');
            loader.style.opacity = '0';
            setTimeout(() => loader.remove(), 500);
        }

        // ==================== RENDER ====================
        function renderUI() {
            addRoutesLayer();
            addPoisLayer(true);      // hidden on init
            addKmMarkers(false);     // all km markers visible on init
            renderRoutesList();
            renderPOIsList();
            setupFilters();
            renderLegend();
            setupMapContextMenu();
            console.log('UI rendered. Routes:', routesData.features.length, 'POIs:', poisData.features.length);
        }

        let routeHandlersBound = false;

        // CHANGE 1: Removed isDarkMode conditionals from addRoutesLayer
        function addRoutesLayer() {
            // Limpiar capas y fuente existentes (necesario tras setStyle)
            try {
                routesData.features.forEach(f => {
                    const id = f.properties.id_ruta;
                    if (map.getLayer(`route-${id}`)) map.removeLayer(`route-${id}`);
                    if (map.getLayer(`route-${id}-casing`)) map.removeLayer(`route-${id}-casing`);
                });
                if (map.getSource('routes')) map.removeSource('routes');
            } catch(e) { /* ignorar si ya no existen */ }

            // Crear fuente y capas desde cero
            map.addSource('routes', { type: 'geojson', data: routesData });

            routesData.features.forEach(f => {
                const id = f.properties.id_ruta;
                const casingColor = 'rgba(255,255,255,0.8)';
                const routeColor = f.properties.color;

                map.addLayer({
                    id: `route-${id}-casing`,
                    type: 'line',
                    source: 'routes',
                    filter: ['==', ['get', 'id_ruta'], id],
                    paint: { 'line-color': casingColor, 'line-width': 9, 'line-opacity': 0.6 },
                    layout: { 'line-cap': 'round', 'line-join': 'round' }
                });
                map.addLayer({
                    id: `route-${id}`,
                    type: 'line',
                    source: 'routes',
                    filter: ['==', ['get', 'id_ruta'], id],
                    paint: { 'line-color': routeColor, 'line-width': 5, 'line-opacity': 1 },
                    layout: { 'line-cap': 'round', 'line-join': 'round' }
                });
            });

            // Solo bind handlers una vez (evita acumulacion)
            if (!routeHandlersBound) {
                routeHandlersBound = true;
                routesData.features.forEach(f => {
                    const id = f.properties.id_ruta;
                    map.on('click', `route-${id}`, e => {
                        const p = e.features[0].properties;
                        showRoutePopup(p, e.lngLat);
                    });
                    map.on('mouseenter', `route-${id}`, () => map.getCanvas().style.cursor = 'pointer');
                    map.on('mouseleave', `route-${id}`, () => map.getCanvas().style.cursor = '');
                });
            }
        }

        // POIs minimalistas en el mapa - puntos coloreados por tipo
        function addPoisLayer(hideInitially) {
            markers.forEach(m => m.remove());
            markers = [];

            poisData.features.forEach(f => {
                const p = f.properties;
                const cfg = POI_CONFIG[p.tipo] || POI_CONFIG.estacion;
                const el = document.createElement('div');
                el.className = 'poi-marker';
                el.style.setProperty('--poi-color', cfg.color);
                el.innerHTML = `${cfg.svg}<span class="poi-tip"><div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;"><span style="width:10px;height:10px;border-radius:50%;background:${cfg.color};flex-shrink:0;"></span><b style="font-size:12px;">${p.titulo}</b></div><span style="color:#6b7280;font-size:10px;">${cfg.label}</span></span>`;
                el.dataset.routeId = p.id_ruta;
                el.dataset.poiType = p.tipo;
                if (hideInitially) el.style.display = 'none';

                const marker = new maplibregl.Marker({ element: el, anchor: 'center' })
                    .setLngLat(f.geometry.coordinates)
                    .addTo(map);

                el.addEventListener('click', () => showPOIPopup(p, f.geometry.coordinates));
                markers.push(marker);
            });
        }

        // CHANGE 5: KM Markers — hidden on init, intermediate at half size
        function addKmMarkers(hideInitially) {
            // Remove existing km markers
            kmMarkers.forEach(m => m.remove());
            kmMarkers = [];

            routesData.features.forEach(f => {
                const props = f.properties;
                const coords = f.geometry.coordinates;
                if (!coords || coords.length < 2) return;

                const totalKm = props.distancia_km;

                // Calculate cumulative distances
                let distances = [0];
                let totalDist = 0;
                for (let i = 1; i < coords.length; i++) {
                    const dx = (coords[i][0] - coords[i-1][0]) * 111320 * Math.cos(coords[i-1][1] * Math.PI / 180);
                    const dy = (coords[i][1] - coords[i-1][1]) * 110540;
                    totalDist += Math.sqrt(dx*dx + dy*dy) / 1000; // km
                    distances.push(totalDist);
                }

                // Scale factor to match declared km
                const scale = totalKm / totalDist;

                // Helper: get coordinate at specific km
                function getCoordAtKm(targetKm) {
                    const targetDist = targetKm / scale;
                    for (let i = 1; i < distances.length; i++) {
                        if (distances[i] >= targetDist) {
                            const t = (targetDist - distances[i-1]) / (distances[i] - distances[i-1]);
                            return [
                                coords[i-1][0] + (coords[i][0] - coords[i-1][0]) * t,
                                coords[i-1][1] + (coords[i][1] - coords[i-1][1]) * t
                            ];
                        }
                    }
                    return [coords[coords.length-1][0], coords[coords.length-1][1]];
                }

                // Check if route is reversed (vv6)
                const reversedRoutes = ['vv6'];
                const isReversed = reversedRoutes.includes(props.id_ruta);

                // START marker (0 km) — always visible
                const startCoord = isReversed ? [coords[coords.length-1][0], coords[coords.length-1][1]] : [coords[0][0], coords[0][1]];
                const startEl = document.createElement('div');
                startEl.className = 'km-marker';
                startEl.innerHTML = '<div class="km-marker-start">0 km</div>';
                const startMarker = new maplibregl.Marker({ element: startEl, anchor: 'center' })
                    .setLngLat(startCoord)
                    .addTo(map);
                startMarker._routeId = props.id_ruta;
                startMarker._kmType = 'start';
                kmMarkers.push(startMarker);

                // Intermediate markers every 10km — compact, always visible
                for (let km = 10; km < totalKm; km += 10) {
                    let coord;
                    if (isReversed) {
                        coord = getCoordAtKm(totalKm - km);
                    } else {
                        coord = getCoordAtKm(km);
                    }
                    const el = document.createElement('div');
                    el.className = 'km-marker km-marker-mini';
                    el.innerHTML = `<div class="km-marker-dot">${km}</div>`;
                    // Always visible — no hideInitially for km markers
                    const marker = new maplibregl.Marker({ element: el, anchor: 'center' })
                        .setLngLat(coord)
                        .addTo(map);
                    marker._routeId = props.id_ruta;
                    marker._kmType = 'intermediate';
                    kmMarkers.push(marker);
                }

                // END marker (total km) — always visible
                const endCoord = isReversed ? [coords[0][0], coords[0][1]] : [coords[coords.length-1][0], coords[coords.length-1][1]];
                const endEl = document.createElement('div');
                endEl.className = 'km-marker';
                endEl.innerHTML = `<div class="km-marker-end">${totalKm} km</div>`;
                const endMarker = new maplibregl.Marker({ element: endEl, anchor: 'center' })
                    .setLngLat(endCoord)
                    .addTo(map);
                endMarker._routeId = props.id_ruta;
                endMarker._kmType = 'end';
                kmMarkers.push(endMarker);
            });
        }

        function showRoutePopup(props, lngLat) {
            const diff = DIFFICULTY[props.dificultad] || DIFFICULTY['fácil'];
            const hasTour = props.url_tour_360 && props.url_tour_360.length > 0;

            const html = `
        <div style="background: linear-gradient(135deg, ${props.color}, ${props.color}cc); padding: 16px; color: white;">
            <h3 style="margin:0 0 4px; font-size:16px; font-weight:600;">${props.nombre}</h3>
            <p style="margin:0; font-size:12px; opacity:0.85;">${props.distancia_km} km · ${formatDuration(props.tiempo_estimado_min)}</p>
        </div>
        <div style="padding: 16px;">
            <p style="font-size:13px; color:var(--text-secondary); margin:0 0 12px;">${props.descripcion_corta}</p>
            <div style="display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap;">
                <span class="badge ${diff.class}">${diff.label}</span>
                <span class="badge" style="background:var(--btn-secondary-bg); color:var(--btn-secondary-text);">${props.superficie}</span>
                ${hasTour ? '<span class="badge badge-tour360">360°</span>' : ''}
            </div>
            <div style="display:flex; gap:8px; margin-bottom:8px;">
                ${hasTour ? `<button onclick="open360Tour('${props.url_tour_360}')" style="flex:1; padding:10px; background:#5A9E8F; color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px; font-weight:500;">Ver Tour 360°</button>` : ''}
                <button onclick="openRouteModal('${props.id_ruta}')" style="flex:1; padding:10px; background:var(--btn-secondary-bg); color:var(--btn-secondary-text); border:none; border-radius:8px; cursor:pointer; font-size:13px; font-weight:500;">Más info</button>
            </div>
            <div class="share-options-container">
                <button onclick="shareWhatsApp('${props.id_ruta}')" class="share-btn share-btn-whatsapp" style="font-size:11px; padding:7px 10px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.284 7.034L.789 23.492a.5.5 0 00.611.611l4.458-1.495A11.96 11.96 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-2.24 0-4.317-.724-6.003-1.952l-.42-.312-2.647.887.887-2.647-.312-.42A9.935 9.935 0 012 12C2 6.486 6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/></svg>
                    WhatsApp
                </button>
                <button onclick="shareTelegram('${props.id_ruta}')" class="share-btn share-btn-telegram" style="font-size:11px; padding:7px 10px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0a12 12 0 00-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 01.171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.492-1.302.48-.428-.013-1.252-.242-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                    Telegram
                </button>
            </div>
        </div>
    `;

            new maplibregl.Popup({ closeOnClick: true, maxWidth: '320px' })
                .setLngLat(lngLat)
                .setHTML(html)
                .addTo(map);
        }

        function showPOIPopup(props, coords) {
            const cfg = POI_CONFIG[props.tipo] || POI_CONFIG.estacion;
            const route = routesData.features.find(f => f.properties.id_ruta === props.id_ruta);
            const routeName = route ? route.properties.nombre : '';
            const hasTour = props.url_tour && props.url_tour.length > 0;

            const html = `
        <div style="background: linear-gradient(135deg, ${cfg.color}, ${cfg.color}cc); padding: 16px; color: white;">
            <h3 style="margin:0 0 4px; font-size:16px; font-weight:600;">${props.titulo}</h3>
            <p style="margin:0; font-size:12px; opacity:0.85;">${cfg.label} · ${routeName.replace('Vía Verde ', '')}</p>
        </div>
        <div style="padding: 16px;">
            <p style="font-size:13px; color:#4b5563; margin:0 0 12px;">${props.descripcion}</p>
            ${hasTour ? `<button onclick="open360Tour('${props.url_tour}')" style="width:100%; padding:10px; background:#5A9E8F; color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px; font-weight:500;">Ver en 360°</button>` : ''}
        </div>
    `;

            new maplibregl.Popup({ closeOnClick: true, maxWidth: '300px' })
                .setLngLat(coords)
                .setHTML(html)
                .addTo(map);
        }

        // ==================== MODAL ====================
        function getRoutePois(routeId) {
            if (!poisData || !poisData.features) return [];
            return poisData.features.filter(f => f.properties.id_ruta === routeId);
        }

        function renderItinerarioTab(routeId) {
            const pois = getRoutePois(routeId).sort((a, b) => (a.properties.orden_ruta || 0) - (b.properties.orden_ruta || 0));
            if (!pois.length) return '<div class="tab-empty"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>No hay datos de itinerario disponibles para esta ruta.</div>';
            const typeColors = {
                estacion: { bg: '#5A9E8F', label: 'Estacion' },
                pueblo: { bg: '#7C3AED', label: 'Pueblo' },
                area_descanso: { bg: '#84CC16', label: 'Descanso' },
                puente: { bg: '#D97706', label: 'Puente' },
                tunel: { bg: '#6B7280', label: 'Tunel' },
                mirador: { bg: '#F59E0B', label: 'Mirador' },
                patrimonio: { bg: '#92400E', label: 'Patrimonio' },
                panel_interpretativo: { bg: '#3B82F6', label: 'Panel' },
                punto_conflictivo: { bg: '#DC2626', label: 'Atencion' },
                albergue: { bg: '#059669', label: 'Albergue' },
                servicio: { bg: '#0EA5E9', label: 'Servicio' },
                restaurante: { bg: '#E11D48', label: 'Restaurante' },
                aparcamiento: { bg: '#2563EB', label: 'Parking' },
                fuente_agua: { bg: '#0891B2', label: 'Fuente' },
                camping: { bg: '#15803D', label: 'Camping' },
                playa: { bg: '#06B6D4', label: 'Playa' },
                centro_salud: { bg: '#E11D48', label: 'Salud' }
            };
            return pois.map((f, idx) => {
                const pr = f.properties;
                const tc = typeColors[pr.tipo] || { bg: '#6B7280', label: pr.tipo };
                const orderNum = pr.orden_ruta || (idx + 1);
                return `<div class="itinerario-step">
                    <div class="itinerario-km">${orderNum}</div>
                    <div class="itinerario-info">
                        <h4>${pr.titulo}</h4>
                        <p>${pr.descripcion || ''}</p>
                        <span class="itinerario-type-badge" style="background:${tc.bg}20; color:${tc.bg};">${tc.label}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderPatrimonioTab(routeId) {
            const patrimonioTypes = ['patrimonio', 'estacion', 'puente', 'tunel', 'mirador'];
            const pois = getRoutePois(routeId)
                .filter(f => patrimonioTypes.includes(f.properties.tipo))
                .sort((a, b) => (a.properties.orden || 0) - (b.properties.orden || 0));
            if (!pois.length) return '<div class="tab-empty"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>No hay puntos de patrimonio registrados.</div>';
            const iconMap = {
                patrimonio: { bg: 'linear-gradient(135deg, #92400E, #78350F)', svg: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>' },
                estacion: { bg: 'linear-gradient(135deg, #5A9E8F, #1E3330)', svg: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' },
                puente: { bg: 'linear-gradient(135deg, #D97706, #B45309)', svg: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11m16-11v11"/></svg>' },
                tunel: { bg: 'linear-gradient(135deg, #6B7280, #4B5563)', svg: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m-8-9H3m18 0h-1M5.6 5.6l.7.7m12.4 12.4l-.7-.7M5.6 18.4l.7-.7M18.4 5.6l-.7.7"/></svg>' },
                mirador: { bg: 'linear-gradient(135deg, #F59E0B, #D97706)', svg: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>' }
            };
            return pois.map(f => {
                const pr = f.properties;
                const ic = iconMap[pr.tipo] || iconMap.patrimonio;
                return `<div class="patrimonio-card">
                    <div class="patrimonio-icon" style="background:${ic.bg}">${ic.svg}</div>
                    <div class="patrimonio-info">
                        <h4>${pr.titulo}</h4>
                        <p>${pr.descripcion || ''}</p>
                    </div>
                </div>`;
            }).join('');
        }

        function renderServiciosTab(routeId) {
            const servicioTypes = ['albergue', 'area_descanso', 'restaurante', 'aparcamiento', 'fuente_agua', 'camping', 'servicio', 'centro_salud'];
            const pois = getRoutePois(routeId)
                .filter(f => servicioTypes.includes(f.properties.tipo))
                .sort((a, b) => (a.properties.orden || 0) - (b.properties.orden || 0));
            if (!pois.length) return '<div class="tab-empty"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>No hay servicios registrados para esta ruta.</div>';
            const svcColors = {
                albergue: { bg: '#059669', label: 'Albergue' },
                area_descanso: { bg: '#84CC16', label: 'Area Descanso' },
                restaurante: { bg: '#E11D48', label: 'Restaurante' },
                aparcamiento: { bg: '#2563EB', label: 'Parking' },
                fuente_agua: { bg: '#0891B2', label: 'Fuente' },
                camping: { bg: '#15803D', label: 'Camping' },
                servicio: { bg: '#0EA5E9', label: 'Servicio' },
                centro_salud: { bg: '#E11D48', label: 'Salud' }
            };
            return pois.map(f => {
                const pr = f.properties;
                const sc = svcColors[pr.tipo] || { bg: '#6B7280', label: pr.tipo };
                return `<div class="servicio-card">
                    <div class="servicio-icon" style="background:${sc.bg}">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><circle cx="12" cy="11" r="3"/></svg>
                    </div>
                    <div class="servicio-info">
                        <h4>${pr.titulo}</h4>
                        <p>${pr.descripcion || sc.label}</p>
                    </div>
                </div>`;
            }).join('');
        }

        function switchModalTab(btn, tabId) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            const target = document.getElementById(tabId);
            if (target) target.classList.add('active');
        }

        function openRouteModal(routeId) {
            const route = routesData.features.find(f => f.properties.id_ruta === routeId);
            if (!route) return;

            // Show POIs and km markers for this route
            focusedRouteId = routeId;
            markers.forEach(m => {
                const el = m.getElement();
                el.style.display = el.dataset.routeId === routeId ? 'flex' : 'none';
            });
            kmMarkers.forEach(m => {
                m.getElement().style.display = m._routeId === routeId ? 'flex' : 'none';
            });

            const p = route.properties;
            const diff = DIFFICULTY[p.dificultad] || DIFFICULTY['fácil'];
            const rawRoute = viasVerdes.find(v => v.id === routeId);
            const status = rawRoute ? rawRoute.status : 'operational';
            const hasTour = status === 'operational' && p.url_tour_360 && p.url_tour_360.length > 0;
            const isSoon = status === 'coming_soon';
            const municipalities = rawRoute && rawRoute.municipality ? rawRoute.municipality.split(', ') : [];
            const gpxFile = rawRoute ? rawRoute.gpxFile : null;

            // Count POIs by category
            const routePois = getRoutePois(routeId);
            const patrimonioCount = routePois.filter(f => ['patrimonio','estacion','puente','tunel','mirador'].includes(f.properties.tipo)).length;
            const serviciosCount = routePois.filter(f => ['albergue','alojamiento','area_descanso','restaurante','aparcamiento','centro_salud','comisaria','farmacia','supermercado','oficina_turismo'].includes(f.properties.tipo)).length;

            const html = `
        <div class="modal-header">
            <img src="${p.image || 'assets/images/placeholder-route.jpg'}" class="modal-header-img" onerror="this.src='https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&w=800&q=80'">
            <div class="modal-header-overlay"></div>
            <button class="modal-close-btn" onclick="closeRouteModal()">×</button>
            <div style="position:absolute; bottom:20px; left:24px; right:24px;">
                <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px;">
                    <span class="badge ${diff.class}">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="margin-right:2px;vertical-align:-1px;"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                        ${diff.label}
                    </span>
                    <span class="badge badge-surface" style="background:rgba(255,255,255,0.2); color:white; backdrop-filter:blur(4px);">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:2px;vertical-align:-1px;"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7"/></svg>
                        ${p.superficie}
                    </span>
                    <span class="badge badge-type" style="background:rgba(255,255,255,0.2); color:white; backdrop-filter:blur(4px);">
                        ${rawRoute && rawRoute.type === 'circular' ? '↻ Circular' : '→ Lineal'}
                    </span>
                    ${isSoon ? '<span class="badge badge-coming-soon" style="background:rgba(255,255,255,0.15); color:white; border-color:rgba(255,255,255,0.3);"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Proximamente</span>' : '<span class="badge badge-operational" style="background:rgba(34,197,94,0.25); color:#bbf7d0;"><svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg> Operativa</span>'}
                </div>
                <h2 style="margin:0; font-size:26px; font-weight:800; color:white; text-shadow:0 2px 10px rgba(0,0,0,0.3); line-height:1.2;">${p.nombre}</h2>
            </div>
        </div>

        <div class="modal-body">
            <!-- Stat Grid -->
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px;">
                <div class="stat-card">
                    <div class="val">${p.distancia_km}</div>
                    <div class="label">Km</div>
                </div>
                <div class="stat-card">
                    <div class="val">${formatDuration(p.tiempo_estimado_min)}</div>
                    <div class="label">Tiempo</div>
                </div>
                <div class="stat-card">
                    <div class="val">${p.perfil_elevacion || 'Suave'}</div>
                    <div class="label">Perfil</div>
                </div>
                <div class="stat-card">
                    <div class="val">${routePois.length}</div>
                    <div class="label">Puntos</div>
                </div>
            </div>

            <!-- Municipality Badges -->
            ${municipalities.length ? `
            <div class="municipality-badges">
                ${municipalities.map(m => `<span class="municipality-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg>${m.trim()}</span>`).join('')}
            </div>` : ''}

            <!-- Tabs -->
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchModalTab(this, 'tab-resumen')">Resumen</button>
                <button class="modal-tab" onclick="switchModalTab(this, 'tab-itinerario')">Itinerario (${routePois.length})</button>
                <button class="modal-tab" onclick="switchModalTab(this, 'tab-patrimonio')">Patrimonio (${patrimonioCount})</button>
                <button class="modal-tab" onclick="switchModalTab(this, 'tab-servicios')">Servicios (${serviciosCount})</button>
                <button class="modal-tab" onclick="switchModalTab(this, 'tab-acceso')">🚌 Acceso</button>
            </div>

            <!-- Tab: Resumen -->
            <div id="tab-resumen" class="modal-tab-content active">
                <div class="chart-container">
                    <h3 style="font-size:13px; font-weight:700; margin-bottom:12px; color:#64748b; text-transform:uppercase; letter-spacing:0.05em;">Perfil Altimetrico</h3>
                    <div style="height:140px;">
                        <canvas id="elevationChart"></canvas>
                    </div>
                    <div id="chartStats" class="chart-stats"></div>
                </div>

                <p style="font-size:14px; color:var(--text-secondary); line-height:1.6; margin-bottom:20px;">${p.descripcion_corta}</p>

                <!-- Weather Section -->
                ${typeof allWeatherData !== 'undefined' && allWeatherData[routeId] ? renderModalWeatherSection(allWeatherData[routeId], routeId) : ''}

                ${isSoon ? '<div style="padding:12px; background:#fff7ed; border:1px solid #ffedd5; border-radius:12px; font-size:12px; color:#9a3412; text-align:center; margin-bottom:16px;">Esta ruta esta actualmente en desarrollo. Proximamente disponible.</div>' : ''}

                <!-- Action Buttons -->
                <div style="display:flex; gap:10px; margin-bottom:16px;">
                    ${hasTour ? `<button onclick="open360Tour('${p.url_tour_360}')" style="flex:1; padding:14px; background:linear-gradient(135deg, #5A9E8F, #1E3330); color:white; border:none; border-radius:14px; cursor:pointer; font-size:13px; font-weight:700; box-shadow:0 8px 16px -4px rgba(90, 158, 143, 0.4); display:flex; align-items:center; justify-content:center; gap:6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"/></svg>
                        Tour 360°
                    </button>` : ''}
                    <button onclick="zoomToRoute('${routeId}'); closeRouteModal();" style="flex:1; padding:14px; background:var(--btn-secondary-bg); color:var(--btn-secondary-text); border:none; border-radius:14px; cursor:pointer; font-size:13px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                        Ver en mapa
                    </button>
                </div>

                <!-- GPX Download -->
                ${gpxFile ? `<button onclick="window.open('gpx/${gpxFile}','_blank')" class="gpx-download-btn" style="margin-bottom:16px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Descargar GPX
                </button>` : ''}

                <!-- Share -->
                <div>
                    <h4 style="font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:10px;">Compartir ruta</h4>
                    <div class="share-options-container">
                        <button onclick="shareWhatsApp('${routeId}')" class="share-btn share-btn-whatsapp">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.284 7.034L.789 23.492a.5.5 0 00.611.611l4.458-1.495A11.96 11.96 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-2.24 0-4.317-.724-6.003-1.952l-.42-.312-2.647.887.887-2.647-.312-.42A9.935 9.935 0 012 12C2 6.486 6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/></svg>
                            WhatsApp
                        </button>
                        <button onclick="shareTelegram('${routeId}')" class="share-btn share-btn-telegram">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0a12 12 0 00-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 01.171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.492-1.302.48-.428-.013-1.252-.242-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                            Telegram
                        </button>
                        <button onclick="shareTwitter('${routeId}')" class="share-btn share-btn-twitter">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            X
                        </button>
                        <button onclick="shareEmail('${routeId}')" class="share-btn share-btn-email">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            Email
                        </button>
                        <button onclick="shareCopyLink('${routeId}')" class="share-btn share-btn-copy">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                            Copiar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab: Itinerario -->
            <div id="tab-itinerario" class="modal-tab-content">
                ${renderItinerarioTab(routeId)}
            </div>

            <!-- Tab: Patrimonio -->
            <div id="tab-patrimonio" class="modal-tab-content">
                ${renderPatrimonioTab(routeId)}
            </div>

            <!-- Tab: Servicios -->
            <div id="tab-servicios" class="modal-tab-content">
                ${renderServiciosTab(routeId)}
            </div>

            <!-- Tab: Acceso (Transporte) -->
            <div id="tab-acceso" class="modal-tab-content">
                ${typeof renderAccesoTab === 'function' ? renderAccesoTab(routeId) : '<p style="text-align:center;color:var(--text-muted);padding:20px;">Cargando transporte...</p>'}
            </div>
        </div>
    `;

            const container = document.getElementById('routeModal');
            container.innerHTML = `<div style="position:absolute;inset:0;" onclick="closeRouteModal()"></div><div class="modal-content" onclick="event.stopPropagation()">${html}</div>`;
            container.classList.remove('hidden');
            container.classList.add('modal-container');

            setTimeout(() => renderElevationChart(routeId), 300);
        }

        let elevationChart = null;
        function renderElevationChart(routeId) {
            const route = routesData.features.find(f => f.properties.id_ruta === routeId);
            if (!route || !route.geometry.coordinates.length) return;

            const coords = route.geometry.coordinates;
            const ctx = document.getElementById('elevationChart');
            if (!ctx) return;

            if (elevationChart) elevationChart.destroy();

            const step = Math.max(1, Math.floor(coords.length / 100));
            const dataPuntos = coords.filter((_, i) => i % step === 0);

            let currentDist = 0;
            const labels = [];
            const altitudes = [];
            let maxAlt = -Infinity;
            let minAlt = Infinity;
            let totalAscent = 0;

            for (let i = 0; i < dataPuntos.length; i++) {
                const alt = dataPuntos[i][2] || 0;
                if (alt > maxAlt) maxAlt = alt;
                if (alt < minAlt) minAlt = alt;

                if (i > 0) {
                    const p1 = dataPuntos[i - 1];
                    const p2 = dataPuntos[i];
                    const dx = (p2[0] - p1[0]) * 111.32 * Math.cos(p1[1] * Math.PI / 180);
                    const dy = (p2[1] - p1[1]) * 111.32;
                    currentDist += Math.sqrt(dx * dx + dy * dy);

                    const diff = alt - (p1[2] || 0);
                    if (diff > 0) totalAscent += diff;
                }
                labels.push(currentDist.toFixed(1) + ' km');
                altitudes.push(alt);
            }

            document.getElementById('chartStats').innerHTML = `
                <div class="chart-stat-item"><div class="chart-stat-val">+${Math.round(totalAscent)}m</div><div class="chart-stat-lbl">Subida</div></div>
                <div class="chart-stat-item"><div class="chart-stat-val">${Math.round(maxAlt)}m</div><div class="chart-stat-lbl">Máx</div></div>
                <div class="chart-stat-item"><div class="chart-stat-val">${Math.round(minAlt)}m</div><div class="chart-stat-lbl">Mín</div></div>
            `;

            elevationChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Altitud',
                        data: altitudes,
                        borderColor: '#5A9E8F',
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const { ctx, chartArea } = chart;
                            if (!chartArea) return null;
                            const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            gradient.addColorStop(0, 'rgba(90, 158, 143, 0.35)');
                            gradient.addColorStop(1, 'rgba(90, 158, 143, 0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        x: { display: false },
                        y: { display: true, ticks: { font: { size: 10 } }, grid: { borderDash: [5, 5], color: '#f1f5f9' } }
                    }
                }
            });
        }

        function closeRouteModal() {
            const el = document.getElementById('routeModal');
            el.classList.add('hidden');
            el.classList.remove('modal-container');
            // Hide POIs, show all km markers
            focusedRouteId = null;
            markers.forEach(m => m.getElement().style.display = 'none');
            kmMarkers.forEach(m => {
                m.getElement().style.display = 'flex';
            });
        }

        // ==================== 360 TOUR ====================
        function open360Tour(url) {
            if (!url) return;
            document.getElementById('tour360Frame').src = url;
            document.getElementById('tour360Modal').classList.remove('hidden');
        }

        function close360Tour() {
            document.getElementById('tour360Modal').classList.add('hidden');
            document.getElementById('tour360Frame').src = '';
        }

        // ==================== INFO SIDE PANEL ====================
        function openInfoPanel() {
            // Apply translations to info panel content
            applyInfoPanelTranslations();
            const panel = document.getElementById('infoSidePanel');
            const overlay = document.getElementById('infoSideOverlay');
            panel.classList.add('open');
            overlay.classList.add('open');
        }

        function closeInfoPanel() {
            const panel = document.getElementById('infoSidePanel');
            const overlay = document.getElementById('infoSideOverlay');
            panel.classList.remove('open');
            overlay.classList.remove('open');
        }

        // Keep backward compatibility
        function openInfoModal() { openInfoPanel(); }
        function closeInfoModal() { closeInfoPanel(); }

        function applyInfoPanelTranslations() {
            const title = document.getElementById('infoPanelTitle');
            const slogan = document.getElementById('infoPanelSlogan');
            const desc = document.getElementById('infoPanelDesc');
            const consortium = document.getElementById('infoPanelConsortium');
            const practical = document.getElementById('infoPanelPractical');
            const links = document.getElementById('infoPanelLinks');
            const institutions = document.getElementById('infoPanelInstitutions');
            const credit = document.getElementById('infoPanelCredit');
            if (title) title.textContent = t('infoTitle');
            if (slogan) slogan.textContent = t('infoSlogan');
            if (desc) desc.textContent = t('infoDesc');
            if (consortium) {
                const svgEl = consortium.querySelector('svg');
                consortium.textContent = '';
                if (svgEl) consortium.appendChild(svgEl);
                consortium.appendChild(document.createTextNode(' ' + t('consortium')));
            }
            if (practical) {
                const svgEl = practical.querySelector('svg');
                practical.textContent = '';
                if (svgEl) practical.appendChild(svgEl);
                practical.appendChild(document.createTextNode(' ' + t('practicalInfo')));
            }
            if (links) {
                const svgEl = links.querySelector('svg');
                links.textContent = '';
                if (svgEl) links.appendChild(svgEl);
                links.appendChild(document.createTextNode(' ' + t('usefulLinks')));
            }
            if (institutions) {
                const svgEl = institutions.querySelector('svg');
                institutions.textContent = '';
                if (svgEl) institutions.appendChild(svgEl);
                institutions.appendChild(document.createTextNode(' ' + t('institutions')));
            }
            if (credit) credit.textContent = t('footerCredit');
            // Accordion items with data-i18n-content
            document.querySelectorAll('[data-i18n-content]').forEach(el => {
                const key = el.dataset.i18nContent;
                if (key) el.textContent = t(key);
            });
        }

        function toggleInfoAccordion(btn) {
            const content = btn.nextElementSibling;
            const chevron = btn.querySelector('.info-chevron');
            const isOpen = !content.classList.contains('hidden');
            if (isOpen) {
                content.classList.add('hidden');
                chevron.classList.remove('info-chevron-open');
            } else {
                content.classList.remove('hidden');
                chevron.classList.add('info-chevron-open');
            }
        }

        // ==================== SIDEBAR ====================
        function renderRoutesList() {
            const container = document.getElementById('routesContent');
            const visibleFeatures = routesData.features.filter(f => isRouteVisible(f.properties.id_ruta));
            container.innerHTML = visibleFeatures.map((f, i) => {
                const p = f.properties;
                const diff = DIFFICULTY[p.dificultad] || DIFFICULTY['fácil'];
                const rawRoute = viasVerdes.find(v => v.id === p.id_ruta);
                const status = rawRoute ? rawRoute.status : 'operational';
                const isSoon = status === 'coming_soon';
                const hasTour = !isSoon && p.url_tour_360 && p.url_tour_360.length > 0;
                return `
        <div class="route-card" onclick="openRouteModal('${p.id_ruta}')">
            <div style="display:flex; gap:12px; margin-bottom:10px;">
                <div style="width:36px; height:36px; border-radius:50%; background:${p.color}; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:14px; flex-shrink:0;">${rawRoute ? rawRoute.num : (i + 1)}</div>
                <div style="flex:1; min-width:0;">
                    <div style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:2px;">${p.nombre}</div>
                    <div style="font-size:12px; color:var(--text-secondary); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${p.descripcion_corta}</div>
                </div>
            </div>
            <div style="display:flex; gap:12px; font-size:11px; color:var(--text-secondary); margin-bottom:8px;">
                <span>${p.distancia_km} km</span>
                <span>${formatDuration(p.tiempo_estimado_min)}</span>
                <span>${p.perfil_elevacion || 'Suave'}</span>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                <span class="badge ${diff.class}">${diff.label}</span>
                <span class="badge" style="background:var(--btn-secondary-bg); color:var(--btn-secondary-text);">${p.superficie}</span>
                ${isSoon ? '<span class="badge badge-soon">PRÓXIMAMENTE</span>' : ''}
                ${typeof allWeatherData !== 'undefined' && allWeatherData[p.id_ruta] ? renderWeatherBadge(allWeatherData[p.id_ruta]) : ''}
            </div>
            ${hasTour ? `<div class="tour360-card-banner" onclick="event.stopPropagation(); open360Tour('${p.url_tour_360}')">
                <div style="display:flex; align-items:center; gap:8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                    <span style="font-size:12px; font-weight:700; color:white;">Tour 360°</span>
                </div>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
            </div>` : ''}
        </div>`;
            }).join('');
        }

        function renderPOIsList(filterText) {
            const container = document.getElementById('poisContent');

            // Count POIs by type for summary bar
            const typeCounts = {};
            poisData.features.forEach(f => {
                const tipo = f.properties.tipo;
                if (filterText) {
                    const q = filterText.toLowerCase();
                    const cfg = POI_CONFIG[tipo] || POI_CONFIG.estacion;
                    if (!f.properties.titulo.toLowerCase().includes(q) && !cfg.label.toLowerCase().includes(q) && !f.properties.descripcion.toLowerCase().includes(q)) return;
                }
                typeCounts[tipo] = (typeCounts[tipo] || 0) + 1;
            });

            // Category summary bar with labels
            let summaryHtml = '<div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:12px; padding:0 2px;">';
            Object.entries(POI_CONFIG).forEach(([key, cfg]) => {
                const count = typeCounts[key] || 0;
                if (count === 0) return;
                summaryHtml += `<div style="display:flex; align-items:center; gap:4px; padding:4px 8px; background:${cfg.color}12; border:1px solid ${cfg.color}33; border-radius:8px; font-size:10px; color:${cfg.color}; font-weight:600; cursor:pointer; transition:background 0.15s;" onmouseover="this.style.background='${cfg.color}22'" onmouseout="this.style.background='${cfg.color}12'" onclick="filterPoisByType('${key}', '${cfg.label}')">
                    <span style="width:14px; height:14px; display:flex; align-items:center; justify-content:center;">${cfg.svg}</span>
                    <span style="font-size:9px; font-weight:500; max-width:60px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${cfg.label}</span>
                    <span style="opacity:0.7;">${count}</span>
                </div>`;
            });
            summaryHtml += '</div>';

            // Grouped by route
            const grouped = {};
            routesData.features.forEach(r => {
                grouped[r.properties.id_ruta] = { route: r, pois: [] };
            });
            poisData.features.forEach(f => {
                const p = f.properties;
                if (filterText) {
                    const q = filterText.toLowerCase();
                    const cfg = POI_CONFIG[p.tipo] || POI_CONFIG.estacion;
                    if (!p.titulo.toLowerCase().includes(q) && !cfg.label.toLowerCase().includes(q) && !p.descripcion.toLowerCase().includes(q)) return;
                }
                if (grouped[p.id_ruta]) grouped[p.id_ruta].pois.push(f);
            });

            let html = summaryHtml;
            Object.values(grouped).forEach(g => {
                if (g.pois.length === 0) return;
                const rp = g.route.properties;
                const routeShort = rp.nombre.replace('Vía Verde ', '');
                html += `
        <div style="margin-bottom:8px;">
            <div onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.poi-chevron').classList.toggle('poi-chevron-open')" style="display:flex; align-items:center; gap:8px; padding:10px 12px; background:linear-gradient(135deg, ${rp.color}22, ${rp.color}11); border:1px solid ${rp.color}44; border-radius:10px; cursor:pointer; user-select:none;">
                <span style="width:14px; height:4px; border-radius:2px; background:${rp.color}; flex-shrink:0;"></span>
                <span style="flex:1; font-size:13px; font-weight:700; color:var(--text-primary);">${routeShort}</span>
                <span style="font-size:11px; color:var(--text-secondary); background:var(--btn-secondary-bg); padding:2px 8px; border-radius:10px;">${g.pois.length}</span>
                <svg class="poi-chevron" style="width:16px; height:16px; color:var(--text-secondary); transition:transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </div>
            <div class="poi-group-items hidden" style="flex-direction:column; gap:4px; padding:6px 0 0 18px;">`;
                g.pois.forEach(f => {
                    const p = f.properties;
                    const cfg = POI_CONFIG[p.tipo] || POI_CONFIG.estacion;
                    html += `
                <div style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:var(--card-bg); border-radius:8px; border:1px solid var(--card-border); cursor:pointer;" onclick="flyToPOI(${f.geometry.coordinates[0]}, ${f.geometry.coordinates[1]})">
                    <div style="width:30px; height:30px; border-radius:50%; background:white; border:2px solid ${cfg.color}; display:flex; align-items:center; justify-content:center; flex-shrink:0; color:${cfg.color};">${cfg.svg}</div>
                    <div style="flex:1; min-width:0;">
                        <div style="font-size:12px; font-weight:600; color:var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.titulo}</div>
                        <div style="font-size:10px; color:${cfg.color}; font-weight:500;">${cfg.label}</div>
                    </div>
                </div>`;
                });
                html += `
            </div>
        </div>`;
            });
            container.innerHTML = html || '<p style="text-align:center; color:var(--text-secondary); font-size:13px; padding:20px;">No se encontraron puntos de interés</p>';
        }

        function setupFilters() {
            document.getElementById('routeFilters').innerHTML = routesData.features.map(f => {
                const p = f.properties;
                return `<label class="filter-item"><input type="checkbox" value="${p.id_ruta}" checked onchange="toggleFilter('routes', '${p.id_ruta}')"><span style="width:12px; height:12px; border-radius:50%; background:${p.color};"></span><span style="font-size:13px;">${p.nombre.replace('Vía Verde ', '')}</span></label>`;
            }).join('');

            document.getElementById('poiFilters').innerHTML = Object.entries(POI_CONFIG).map(([k, v]) =>
                `<label class="filter-item"><input type="checkbox" value="${k}" checked onchange="toggleFilter('poiTypes', '${k}')"><span style="width:18px; height:18px; border-radius:50%; background:white; border:2px solid ${v.color}; display:inline-flex; align-items:center; justify-content:center; flex-shrink:0;"><span style="width:10px; height:10px; display:flex; align-items:center; justify-content:center; color:${v.color};">${v.svg}</span></span><span style="font-size:13px;">${v.label}</span></label>`
            ).join('');

            document.getElementById('difficultyFilters').innerHTML = Object.entries(DIFFICULTY).map(([k, v]) =>
                `<label class="filter-item"><input type="checkbox" value="${k}" checked onchange="toggleFilter('difficulties', '${k}')"><span style="width:12px; height:12px; border-radius:50%; background:${v.color};"></span><span style="font-size:13px;">${v.label}</span></label>`
            ).join('');

            // Filtros de distancia
            document.getElementById('distanceFilters').innerHTML = Object.entries(DISTANCE_RANGES).map(([k, v]) =>
                `<label class="filter-item"><input type="checkbox" value="${k}" checked onchange="toggleFilter('distances', '${k}')"><span style="width:12px; height:12px; border-radius:50%; background:${v.color};"></span><span style="font-size:13px;">${v.label}</span></label>`
            ).join('');

            // Filtros de tipo de ruta
            document.getElementById('typeFilters').innerHTML = Object.entries(TYPE_CONFIG).map(([k, v]) =>
                `<label class="filter-item"><input type="checkbox" value="${k}" checked onchange="toggleFilter('types', '${k}')"><span style="font-size:16px; line-height:1;">${v.icon}</span><span style="font-size:13px;">${v.label}</span></label>`
            ).join('');

            // Filtros de etiquetas
            const allTags = new Set();
            viasVerdes.forEach(v => { if (v.tags) v.tags.forEach(t => allTags.add(t)); });
            document.getElementById('tagFilters').innerHTML = Array.from(allTags).map(tag =>
                `<label class="filter-item" style="padding:6px 10px;"><input type="checkbox" value="${tag}" checked onchange="toggleFilter('tags', '${tag}')"><span style="font-size:12px;">${tag}</span></label>`
            ).join('');
        }

        function renderLegend() {
            document.getElementById('legendItems').innerHTML = routesData.features.map(f => {
                const p = f.properties;
                return `<div onclick="focusRoute('${p.id_ruta}')" style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:2px 0; border-radius:6px; transition:background 0.15s;" onmouseover="this.style.background='rgba(158,27,50,0.06)'" onmouseout="this.style.background='transparent'"><span style="width:20px; height:3px; border-radius:2px; background:${p.color};"></span><span style="font-size:11px; color:var(--text-secondary);">${p.nombre.replace('Vía Verde ', '')}</span></div>`;
            }).join('');
        }

        // Filter POIs by type and show on map
        function filterPoisByType(poiType, label) {
            // Update search and list
            const searchEl = document.getElementById('searchInput');
            if (searchEl) { searchEl.value = label; }
            renderPOIsList(label);
            // Show matching POIs on map
            focusedRouteId = '__all__';
            markers.forEach(m => {
                const el = m.getElement();
                const type = el.dataset.poiType;
                el.style.display = type === poiType ? 'flex' : 'none';
            });
            // Fit map to show all visible POI markers
            const visibleCoords = [];
            markers.forEach(m => {
                if (m.getElement().style.display !== 'none') {
                    visibleCoords.push(m.getLngLat());
                }
            });
            if (visibleCoords.length > 0) {
                const bounds = visibleCoords.reduce((b, c) => b.extend(c), new maplibregl.LngLatBounds(visibleCoords[0], visibleCoords[0]));
                map.fitBounds(bounds, { padding: 80, duration: 1000, maxZoom: 13 });
            }
        }

        // Focus a route: zoom, show its POIs and km markers
        let focusedRouteId = null;
        function focusRoute(routeId) {
            if (focusedRouteId === routeId) {
                // Unfocus: hide POIs, show all km markers
                focusedRouteId = null;
                markers.forEach(m => m.getElement().style.display = 'none');
                kmMarkers.forEach(m => {
                    m.getElement().style.display = 'flex';
                });
                return;
            }
            focusedRouteId = routeId;
            zoomToRoute(routeId);
            // Show only this route's POIs
            markers.forEach(m => {
                const el = m.getElement();
                el.style.display = el.dataset.routeId === routeId ? 'flex' : 'none';
            });
            // Show only this route's km markers
            kmMarkers.forEach(m => {
                m.getElement().style.display = m._routeId === routeId ? 'flex' : 'none';
            });
        }

        // ==================== FILTERS ====================
        function toggleFilter(type, value) {
            const idx = activeFilters[type].indexOf(value);
            if (idx > -1) activeFilters[type].splice(idx, 1);
            else activeFilters[type].push(value);
            applyFilters();
        }

        function isRouteVisible(routeId) {
            const feature = routesData.features.find(f => f.properties.id_ruta === routeId);
            if (!feature) return false;
            const raw = viasVerdes.find(v => v.id === routeId);
            if (!raw) return false;

            const diff = feature.properties.dificultad;
            const km = parseFloat(raw.km);
            const type = raw.type || 'lineal';
            const status = raw.status || 'operational';
            const tags = raw.tags || [];

            // Verificar filtro de ruta individual
            if (!activeFilters.routes.includes(routeId)) return false;
            // Verificar dificultad
            if (!activeFilters.difficulties.includes(diff)) return false;
            // Verificar tipo
            if (!activeFilters.types.includes(type)) return false;
            // Verificar distancia
            let distMatch = false;
            for (const rangeKey of activeFilters.distances) {
                const range = DISTANCE_RANGES[rangeKey];
                if (km >= range.min && km < range.max) { distMatch = true; break; }
            }
            if (!distMatch) return false;
            // Verificar etiquetas (al menos una coincida)
            if (activeFilters.tags.length > 0 && tags.length > 0) {
                const hasTag = tags.some(t => activeFilters.tags.includes(t));
                if (!hasTag) return false;
            }
            return true;
        }

        function applyFilters() {
            routesData.features.forEach(f => {
                const id = f.properties.id_ruta;
                const visible = isRouteVisible(id);
                if (map.getLayer(`route-${id}`)) {
                    map.setLayoutProperty(`route-${id}`, 'visibility', visible ? 'visible' : 'none');
                    map.setLayoutProperty(`route-${id}-casing`, 'visibility', visible ? 'visible' : 'none');
                }
            });

            // POIs: show only if a route is focused or POI tab is active
            if (focusedRouteId === '__all__') {
                // Show all POIs matching filters
                markers.forEach(m => {
                    const el = m.getElement();
                    const routeId = el.dataset.routeId;
                    const poiType = el.dataset.poiType;
                    const routeVisible = isRouteVisible(routeId);
                    const poiVisible = activeFilters.poiTypes.includes(poiType);
                    el.style.display = (routeVisible && poiVisible) ? 'flex' : 'none';
                });
                // Show all km markers for visible routes
                kmMarkers.forEach(m => {
                    const routeVisible = isRouteVisible(m._routeId);
                    m.getElement().style.display = routeVisible ? 'flex' : 'none';
                });
            } else if (focusedRouteId) {
                // Show only focused route's POIs and ALL km markers
                markers.forEach(m => {
                    const el = m.getElement();
                    const routeId = el.dataset.routeId;
                    const poiType = el.dataset.poiType;
                    const routeVisible = isRouteVisible(routeId) && routeId === focusedRouteId;
                    const poiVisible = activeFilters.poiTypes.includes(poiType);
                    el.style.display = (routeVisible && poiVisible) ? 'flex' : 'none';
                });
                kmMarkers.forEach(m => {
                    const routeVisible = isRouteVisible(m._routeId);
                    m.getElement().style.display = routeVisible ? 'flex' : 'none';
                });
            } else {
                // No route focused — hide POIs, show all km markers for visible routes
                markers.forEach(m => m.getElement().style.display = 'none');
                kmMarkers.forEach(m => {
                    const routeVisible = isRouteVisible(m._routeId);
                    m.getElement().style.display = routeVisible ? 'flex' : 'none';
                });
            }

            // Actualizar lista del sidebar
            renderRoutesList();
        }

        function resetFilters() {
            activeFilters.routes = routesData.features.map(f => f.properties.id_ruta);
            activeFilters.poiTypes = Object.keys(POI_CONFIG);
            activeFilters.difficulties = Object.keys(DIFFICULTY);
            activeFilters.distances = Object.keys(DISTANCE_RANGES);
            activeFilters.types = Object.keys(TYPE_CONFIG);
            const allTags = new Set();
            viasVerdes.forEach(v => { if (v.tags) v.tags.forEach(t => allTags.add(t)); });
            activeFilters.tags = Array.from(allTags);
            document.querySelectorAll('#filtersContent input[type="checkbox"]').forEach(cb => cb.checked = true);
            applyFilters();
        }

        // ==================== NAVIGATION ====================
        function zoomToRoute(routeId) {
            const route = routesData.features.find(f => f.properties.id_ruta === routeId);
            if (!route) return;
            const coords = route.geometry.coordinates;
            const bounds = coords.reduce((b, c) => b.extend(c), new maplibregl.LngLatBounds(coords[0], coords[0]));
            map.fitBounds(bounds, { padding: 80, duration: 1000 });
        }

        function flyToPOI(lng, lat) {
            map.flyTo({ center: [lng, lat], zoom: 15, duration: 1000 });
        }

        function resetView() {
            focusedRouteId = null;
            markers.forEach(m => m.getElement().style.display = 'none');
            kmMarkers.forEach(m => {
                m.getElement().style.display = 'flex';
            });
            map.flyTo({ center: APP_CONFIG.center, zoom: APP_CONFIG.zoom, duration: 1000 });
        }

        function locateUser() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(pos => {
                    map.flyTo({ center: [pos.coords.longitude, pos.coords.latitude], zoom: 14, duration: 1000 });
                    new maplibregl.Marker({ color: '#3b82f6' }).setLngLat([pos.coords.longitude, pos.coords.latitude]).addTo(map);
                }, err => alert('No se pudo obtener tu ubicación'));
            }
        }

        // CHANGE 2: Simplified reloadMapLayers (fallback only)
        function reloadMapLayers() {
            try {
                routeHandlersBound = false;
                addRoutesLayer();
                addPoisLayer(!focusedRouteId);
                addKmMarkers(!focusedRouteId);
                loadBoundary();
                applyFilters();
            } catch(e) {
                console.warn('Error recargando capas, reintentando...', e);
                setTimeout(reloadMapLayers, 500);
            }
        }

        // CHANGE 2: Real Satellite Map using raster tiles (no setStyle)
        function toggleSatellite() {
            isSatellite = !isSatellite;
            if (isSatellite) {
                // Add satellite raster layer
                if (!map.getSource('satellite-tiles')) {
                    map.addSource('satellite-tiles', {
                        type: 'raster',
                        tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        maxzoom: 18
                    });
                }
                if (!map.getLayer('satellite-layer')) {
                    // Insert satellite on top of basemap but below our custom layers
                    // Find our first custom layer to insert before it
                    const customLayerIds = ['mask-fill', 'murcia-highlight', 'boundary-glow', 'boundary-stroke'];
                    routesData.features.forEach(f => {
                        customLayerIds.push(`route-${f.properties.id_ruta}-casing`);
                        customLayerIds.push(`route-${f.properties.id_ruta}`);
                    });
                    let beforeId = null;
                    for (const lid of customLayerIds) {
                        if (map.getLayer(lid)) { beforeId = lid; break; }
                    }
                    map.addLayer({
                        id: 'satellite-layer',
                        type: 'raster',
                        source: 'satellite-tiles',
                        paint: { 'raster-opacity': 1 }
                    }, beforeId);
                }
                // Make route lines white for contrast on satellite
                routesData.features.forEach(f => {
                    const id = f.properties.id_ruta;
                    if (map.getLayer(`route-${id}`)) {
                        map.setPaintProperty(`route-${id}`, 'line-color', '#ffffff');
                        map.setPaintProperty(`route-${id}`, 'line-width', 4);
                    }
                    if (map.getLayer(`route-${id}-casing`)) {
                        map.setPaintProperty(`route-${id}-casing`, 'line-color', 'rgba(0,0,0,0.5)');
                        map.setPaintProperty(`route-${id}-casing`, 'line-width', 7);
                    }
                });
                // Enhance start/end markers visibility on satellite
                document.querySelectorAll('.km-marker-start').forEach(el => {
                    el.style.boxShadow = '0 2px 12px rgba(90, 158, 143, 0.6), 0 0 0 2px rgba(255,255,255,0.8)';
                });
                document.querySelectorAll('.km-marker-end').forEach(el => {
                    el.style.boxShadow = '0 2px 12px rgba(30, 51, 48, 0.6), 0 0 0 2px rgba(255,255,255,0.8)';
                });
                document.querySelectorAll('.km-marker-dot').forEach(el => {
                    el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.6)';
                });
            } else {
                // Remove satellite layer
                if (map.getLayer('satellite-layer')) map.removeLayer('satellite-layer');
                if (map.getSource('satellite-tiles')) map.removeSource('satellite-tiles');
                // Restore route colors
                routesData.features.forEach(f => {
                    const id = f.properties.id_ruta;
                    if (map.getLayer(`route-${id}`)) {
                        map.setPaintProperty(`route-${id}`, 'line-color', f.properties.color);
                        map.setPaintProperty(`route-${id}`, 'line-width', 5);
                    }
                    if (map.getLayer(`route-${id}-casing`)) {
                        map.setPaintProperty(`route-${id}-casing`, 'line-color', 'rgba(255,255,255,0.8)');
                        map.setPaintProperty(`route-${id}-casing`, 'line-width', 9);
                    }
                });
                // Restore marker shadows to normal
                document.querySelectorAll('.km-marker-start').forEach(el => {
                    el.style.boxShadow = '';
                });
                document.querySelectorAll('.km-marker-end').forEach(el => {
                    el.style.boxShadow = '';
                });
                document.querySelectorAll('.km-marker-dot').forEach(el => {
                    el.style.boxShadow = '';
                });
            }
            document.getElementById('satelliteBtn').classList.toggle('bg-murcia', isSatellite);
            document.getElementById('satelliteBtn').classList.toggle('text-white', isSatellite);
            const satIcon = document.getElementById('satelliteBtnIcon');
            if (satIcon) satIcon.style.color = isSatellite ? '#FFFFFF' : 'var(--text-secondary)';
        }

        // ==================== TABS ====================
        function switchTab(tab) {
            ['Routes', 'POIs', 'Filters'].forEach(t => {
                const btn = document.getElementById('tab' + t);
                const content = document.getElementById(t.toLowerCase() + 'Content');
                if (!btn || !content) return;
                const isActive = t.toLowerCase() === tab;
                btn.classList.toggle('active', isActive);
                content.classList.toggle('hidden', !isActive);
            });
            // When POI tab is active, show all POIs on map
            if (tab === 'pois') {
                focusedRouteId = '__all__';
                markers.forEach(m => {
                    const el = m.getElement();
                    const routeId = el.dataset.routeId;
                    const poiType = el.dataset.poiType;
                    const routeVisible = isRouteVisible(routeId);
                    el.style.display = (routeVisible && activeFilters.poiTypes.includes(poiType)) ? 'flex' : 'none';
                });
            } else if (focusedRouteId === '__all__') {
                // Leaving POI tab — hide POIs, show all km markers
                focusedRouteId = null;
                markers.forEach(m => m.getElement().style.display = 'none');
                kmMarkers.forEach(m => {
                    m.getElement().style.display = 'flex';
                });
            }
        }

        // ==================== SEARCH ====================
        document.getElementById('searchInput').addEventListener('input', e => {
            const q = e.target.value.trim();
            renderRoutesList();
            renderPOIsList(q || null);
        });

        // ==================== WEATHER FLOATING POPUP ====================
        let weatherPopupOpen = false;
        function toggleWeatherPopup() {
            weatherPopupOpen = !weatherPopupOpen;
            const popup = document.getElementById('weatherPopup');
            const btn = document.getElementById('weatherFloatBtn');
            if (weatherPopupOpen) {
                popup.classList.remove('hidden');
                btn.classList.add('active');
            } else {
                popup.classList.add('hidden');
                btn.classList.remove('active');
            }
        }
        // Close weather popup when clicking outside
        document.addEventListener('click', e => {
            if (weatherPopupOpen && !e.target.closest('#weatherFloatWrapper')) {
                weatherPopupOpen = false;
                document.getElementById('weatherPopup').classList.add('hidden');
                document.getElementById('weatherFloatBtn').classList.remove('active');
            }
        });

        // ==================== LEYENDA REPLEGABLE ====================
        let legendExpanded = false;
        function toggleLegend() {
            legendExpanded = !legendExpanded;
            const content = document.getElementById('legendCollapsible');
            const chevron = document.getElementById('legendChevron');
            if (legendExpanded) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // ==================== KEYBOARD ====================
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { closeRouteModal(); close360Tour(); closeInfoPanel(); }
        });

        // ==================== CHANGE 3: MOBILE SIDEBAR ====================
        function toggleSidebarMobile() {
            const sidebar = document.getElementById('sidebar');
            sidebarExpanded = !sidebarExpanded;
            sidebar.classList.toggle('sidebar-expanded', sidebarExpanded);
        }

        // Show/hide mobile toggle button
        function checkMobileLayout() {
            const isMobile = window.innerWidth <= 1024;
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            if (toggleBtn) {
                toggleBtn.style.display = isMobile ? 'flex' : 'none';
            }
        }
        window.addEventListener('resize', checkMobileLayout);

        // ==================== COMPARTIR (WHATSAPP / TELEGRAM) ====================
        function shareWhatsApp(routeId) {
            const route = viasVerdes.find(v => v.id === routeId);
            if (!route) return;
            const text = `${route.name} - ${route.km} km\n${route.location || 'Region de Murcia'}\n${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareTelegram(routeId) {
            const route = viasVerdes.find(v => v.id === routeId);
            if (!route) return;
            const text = `${route.name} - ${route.km} km - ${route.location || 'Region de Murcia'}`;
            window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareTwitter(routeId) {
            const route = viasVerdes.find(v => v.id === routeId);
            if (!route) return;
            const text = `${route.name} - ${route.km} km en la Region de Murcia 🚴`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        }

        function shareEmail(routeId) {
            const route = viasVerdes.find(v => v.id === routeId);
            if (!route) return;
            const subject = `Via Verde: ${route.name}`;
            const body = `Te comparto esta ruta de las Vias Verdes de Murcia:\n\n${route.name}\n${route.km} km - ${route.location || 'Region de Murcia'}\n${route.desc}\n\nVer mapa: ${window.location.href}`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        function shareCopyLink(routeId) {
            const route = viasVerdes.find(v => v.id === routeId);
            if (!route) return;
            const text = `${route.name} - ${route.km} km - ${window.location.href}`;
            if (navigator.share) {
                navigator.share({ title: 'Vías Verdes de Murcia', text: route.name, url: window.location.href });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Enlace copiado al portapapeles');
                });
            }
        }

        function shareLocationWhatsApp(lng, lat) {
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            const text = `Mira esta ubicacion en Vías Verdes de Murcia:\n${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareLocationTelegram(lng, lat) {
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            const text = `Ubicacion en Vías Verdes de Murcia`;
            window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
        }

        // Menu contextual en el mapa (clic derecho / pulsacion larga)
        function setupMapContextMenu() {
            map.on('contextmenu', (e) => {
                const lng = e.lngLat.lng.toFixed(5);
                const lat = e.lngLat.lat.toFixed(5);
                const html = `
                    <div style="padding:12px; min-width:180px;">
                        <p style="font-size:12px; color:var(--text-secondary); margin:0 0 8px;">Coordenadas: ${lat}, ${lng}</p>
                        <div class="share-options-container">
                            <button onclick="shareLocationWhatsApp(${lng}, ${lat})" class="share-btn share-btn-whatsapp" style="font-size:12px; padding:8px 10px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.284 7.034L.789 23.492a.5.5 0 00.611.611l4.458-1.495A11.96 11.96 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-2.24 0-4.317-.724-6.003-1.952l-.42-.312-2.647.887.887-2.647-.312-.42A9.935 9.935 0 012 12C2 6.486 6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/></svg>
                                WhatsApp
                            </button>
                            <button onclick="shareLocationTelegram(${lng}, ${lat})" class="share-btn share-btn-telegram" style="font-size:12px; padding:8px 10px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0a12 12 0 00-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 01.171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.492-1.302.48-.428-.013-1.252-.242-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                                Telegram
                            </button>
                        </div>
                    </div>`;
                new maplibregl.Popup({ closeOnClick: true, maxWidth: '250px' })
                    .setLngLat(e.lngLat)
                    .setHTML(html)
                    .addTo(map);
            });
        }

        // ==================== PWA ====================
        function installPWA() {
            if (!deferredInstallPrompt) return;
            deferredInstallPrompt.prompt();
            deferredInstallPrompt.userChoice.then((choice) => {
                if (choice.outcome === 'accepted') {
                    console.log('App instalada');
                }
                deferredInstallPrompt = null;
                document.getElementById('installBanner').classList.add('hidden');
            });
        }

        function dismissInstall() {
            document.getElementById('installBanner').classList.add('hidden');
        }

        console.log('Vías Verdes de Murcia v1.2 - Ready!');
    </script>

    <!-- Banner de instalacion PWA -->
    <div id="installBanner" class="hidden fixed bottom-4 left-4 right-4 z-50 rounded-2xl shadow-xl p-4 flex items-center justify-between gap-3" style="background:var(--card-bg); border:1px solid var(--border-color);">
        <div class="flex items-center gap-3">
            <img src="assets/images/logo principal vias verdes_1.webp" class="w-20 h-20 rounded-lg object-contain" alt="VV">
            <div>
                <p class="font-semibold text-sm" style="color:var(--text-primary);">Instalar Vías Verdes</p>
                <p class="text-xs" style="color:var(--text-secondary);">Accede sin conexion desde tu movil</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="installPWA()" class="px-4 py-2 bg-murcia text-white rounded-lg text-sm font-semibold hover:bg-murcia-dark transition">Instalar</button>
            <button onclick="dismissInstall()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-200 transition" style="color:var(--text-secondary);">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
    </div>
</body>

</html>